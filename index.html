<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA CAI 2026 - GESTI√ìN INTEGRAL</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root { --p: #1a5276; --bg: #f4f6f7; --red: #c0392b; --green: #27ae60; --orange: #e67e22; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; }
        .no-print { display: block; }
        .container { max-width: 1300px; margin: 20px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .uppercase { text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn { background: var(--p); color: white; border: none; padding: 10px; cursor: pointer; border-radius: 4px; font-weight: bold; margin: 2px; }
        .hidden { display: none !important; }
        
        /* Estilos de tabla y filas */
        table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background: #f2f2f2; }
        .row-docente { display: grid; grid-template-columns: 100px 250px 100px 80px 80px 80px 80px 80px; gap: 10px; padding: 10px; border-bottom: 1px solid #eee; align-items: center; }

        /* FORMATO MEDIA HOJA */
        #boleta-impresion { width: 21cm; height: 13.5cm; padding: 1cm; background: white; border: 1px dashed #ccc; margin: 0 auto; }
        .header-boleta { text-align: center; border-bottom: 2px solid var(--p); margin-bottom: 10px; }
        
        @media print {
            .no-print { display: none !important; }
            #container-boleta { display: block !important; }
            #boleta-impresion { border: none; width: 100%; }
            @page { size: letter landscape; margin: 0; }
        }
    </style>
</head>
<body>

    <div id="login-box" class="container" style="max-width:350px; margin-top:100px; text-align:center;">
        <h2 style="color:var(--p);">ACAD√âMICA CAI</h2>
        <input type="text" id="u" placeholder="Usuario">
        <input type="password" id="p" placeholder="Contrase√±a">
        <select id="r">
            <option value="Admin">Administrador</option>
            <option value="Matematica">Docente Matem√°tica</option>
            <option value="Lenguaje">Docente Lenguaje</option>
            <option value="Ciencias">Docente Ciencias</option>
            <option value="Sociales">Docente Sociales</option>
            <option value="Ingles">Docente Ingl√©s</option>
        </select>
        <button class="btn" style="width:100%" onclick="login()">INGRESAR</button>
    </div>

    <div id="app" class="hidden">
        <div class="container no-print">
            <button onclick="location.reload()" style="float:right; background:var(--red);" class="btn">SALIR</button>
            <h3>Panel: <span id="user-tag"></span></h3>

            <div id="admin-panel" class="hidden" style="background:#e8f8f5; padding:15px; border-radius:8px; border:1px solid #a3e4d7;">
                <b>Gesti√≥n de Alumnos:</b>
                <div style="display:grid; grid-template-columns: 1fr 2fr 1.5fr 1fr; gap:10px; margin-top:10px;">
                    <input type="text" id="nc" placeholder="C√ìDIGO" class="uppercase" oninput="this.value=this.value.toUpperCase()">
                    <input type="text" id="nn" placeholder="Nombre Completo">
                    <select id="ng">
                        <option value="">Grado...</option>
                        <option value="Kinder">Kinder</option><option value="Parvularia">Parvularia</option>
                        <option value="1 Grado">1¬∞ Grado</option><option value="2 Grado">2¬∞ Grado</option>
                        <option value="3 Grado">3¬∞ Grado</option><option value="4 Grado">4¬∞ Grado</option>
                        <option value="5 Grado">5¬∞ Grado</option><option value="6 Grado">6¬∞ Grado</option>
                        <option value="7 Grado">7¬∞ Grado</option><option value="8 Grado">8¬∞ Grado</option>
                        <option value="9 Grado">9¬∞ Grado</option><option value="1 A√±o">1¬∞ A√±o Bach</option>
                        <option value="2 A√±o">2¬∞ A√±o Bach</option>
                    </select>
                    <button class="btn" style="background:var(--green);" onclick="saveAlumno()">GUARDAR</button>
                </div>
                <input type="hidden" id="edit-id">
            </div>

            <input type="text" id="search" placeholder="üîç BUSCAR POR NOMBRE O C√ìDIGO..." onkeyup="draw()" class="uppercase" style="margin-top:15px; height:40px;">
            
            <div id="view-admin" class="hidden">
                <table>
                    <thead>
                        <tr><th>C√ìDIGO</th><th>ALUMNO</th><th>GRADO</th><th>PROM</th><th>ACCIONES</th></tr>
                    </thead>
                    <tbody id="list-admin"></tbody>
                </table>
            </div>

            <div id="view-docente" class="hidden">
                <div style="font-weight:bold; background:var(--p); color:white; margin-top:10px;" class="row-docente">
                    <span>C√ìDIGO</span><span>ALUMNO</span><span>GRADO</span><span>ACT(60%)</span><span>EXA(40%)</span><span>ASIS</span><span>INAS</span><span>PERM</span>
                </div>
                <div id="list-docente"></div>
            </div>
        </div>

        <div id="container-boleta" class="hidden">
            <div class="no-print" style="text-align:center; padding:10px;">
                <button class="btn" style="background:var(--green)" onclick="downloadImg()">‚¨áÔ∏è DESCARGAR IMAGEN</button>
                <button class="btn" onclick="window.print()">üñ®Ô∏è IMPRIMIR</button>
                <button class="btn" style="background:var(--red)" onclick="closeBoleta()">CERRAR</button>
            </div>
            <div id="boleta-impresion">
                <div class="header-boleta">
                    <h2>COLEGIO ACAD√âMICO INTEGRAL (CAI)</h2>
                    <p>REPORTE DE NOTAS 2026</p>
                </div>
                <div id="boleta-content"></div>
            </div>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBmw9CdeBr1Z11v0ye4af-WACBeCL5FDc4",
        authDomain: "academica-bcb50.firebaseapp.com",
        projectId: "academica-bcb50",
        databaseURL: "https://academica-bcb50-default-rtdb.firebaseio.com/",
        storageBucket: "academica-bcb50.firebasestorage.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let role = ""; let data = [];

    function login() {
        const creds = { "Admin":["Registro","Admin"], "Matematica":["prof_mate","cai2026"], "Lenguaje":["prof_lenguaje","cai2026"], "Ciencias":["prof_ciencias","cai2026"], "Sociales":["prof_sociales","cai2026"], "Ingles":["prof_ingles","cai2026"] };
        const u = document.getElementById('u').value; const p = document.getElementById('p').value; const r = document.getElementById('r').value;
        if(creds[r] && u === creds[r][0] && p === creds[r][1]) {
            role = r; document.getElementById('login-box').classList.add('hidden'); document.getElementById('app').classList.remove('hidden');
            document.getElementById('user-tag').innerText = role;
            if(role === "Admin") { document.getElementById('admin-panel').classList.remove('hidden'); document.getElementById('view-admin').classList.remove('hidden'); }
            else { document.getElementById('view-docente').classList.remove('hidden'); }
            db.ref('alumnos').on('value', s => { const val = s.val(); data = val ? Object.keys(val).map(k=>({id:k,...val[k]})) : []; draw(); });
        } else alert("Credenciales incorrectas");
    }

    function saveAlumno() {
        const id = document.getElementById('edit-id').value;
        const al = { code: document.getElementById('nc').value.toUpperCase(), name: document.getElementById('nn').value, grade: document.getElementById('ng').value };
        if(!al.code || !al.name) return;
        if(id) db.ref('alumnos/'+id).update(al);
        else {
            al.notas = { Matematica:{a:0,e:0}, Lenguaje:{a:0,e:0}, Ciencias:{a:0,e:0}, Sociales:{a:0,e:0}, Ingles:{a:0,e:0} };
            al.asist = { Matematica:{as:0,in:0,pe:0}, Lenguaje:{as:0,in:0,pe:0}, Ciencias:{as:0,in:0,pe:0}, Sociales:{as:0,in:0,pe:0}, Ingles:{as:0,in:0,pe:0} };
            al.faltas = ""; db.ref('alumnos').push(al);
        }
        document.getElementById('edit-id').value=""; document.getElementById('nc').value=""; document.getElementById('nn').value="";
    }

    function updateNota(id, campo, val) {
        if(role === "Admin") return;
        db.ref(`alumnos/${id}/notas/${role}/${campo}`).set(parseFloat(val) || 0);
    }

    function updateAsist(id, campo, val) {
        if(role === "Admin") return;
        db.ref(`alumnos/${id}/asist/${role}/${campo}`).set(parseInt(val) || 0);
    }

    function draw() {
        const s = document.getElementById('search').value.toUpperCase();
        const filtered = data.filter(a => a.name.toUpperCase().includes(s) || a.code.includes(s));
        
        if(role === "Admin") {
            const list = document.getElementById('list-admin'); list.innerHTML = "";
            filtered.forEach(al => {
                list.innerHTML += `<tr><td>${al.code}</td><td>${al.name}</td><td>${al.grade}</td>
                <td><button class="btn btn-small" onclick="generateBoleta('${al.id}')">üìÑ</button>
                <button class="btn btn-small" style="background:var(--orange)" onclick="editAl('${al.id}')">‚úèÔ∏è</button></td></tr>`;
            });
        } else {
            const list = document.getElementById('list-docente'); list.innerHTML = "";
            filtered.forEach(al => {
                const n = al.notas[role] || {a:0,e:0}; const as = al.asist[role] || {as:0,in:0,pe:0};
                list.innerHTML += `<div class="row-docente">
                    <span>${al.code}</span><span>${al.name}</span><span>${al.grade}</span>
                    <input type="number" value="${n.a}" onchange="updateNota('${al.id}','a',this.value)" step="0.1">
                    <input type="number" value="${n.e}" onchange="updateNota('${al.id}','e',this.value)" step="0.1">
                    <input type="number" value="${as.as}" onchange="updateAsist('${al.id}','as',this.value)">
                    <input type="number" value="${as.in}" onchange="updateAsist('${al.id}','in',this.value)">
                    <input type="number" value="${as.pe}" onchange="updateAsist('${al.id}','pe',this.value)">
                </div>`;
            });
        }
    }

    function generateBoleta(id) {
        const al = data.find(x => x.id === id);
        let total = 0; let rows = "";
        ["Matematica","Lenguaje","Ciencias","Sociales","Ingles"].forEach(m => {
            const n = al.notas[m]; const p = (n.a*0.6+n.e*0.4); total += p;
            rows += `<tr><td>${m}</td><td>${n.a}</td><td>${n.e}</td><td>${p.toFixed(1)}</td></tr>`;
        });
        document.getElementById('boleta-content').innerHTML = `
            <p><b>Alumno:</b> ${al.name} | <b>Grado:</b> ${al.grade}</p>
            <table><tr><th>Materia</th><th>60%</th><th>40%</th><th>PROM</th></tr>${rows}
            <tr><td colspan="3"><b>PROMEDIO FINAL</b></td><td><b>${(total/5).toFixed(2)}</b></td></tr></table>
            <p><b>Conducta:</b> ${al.faltas || 'Excelente'}</p>`;
        document.getElementById('container-boleta').classList.remove('hidden');
        document.querySelector('.no-print').classList.add('hidden');
    }

    function closeBoleta() { document.getElementById('container-boleta').classList.add('hidden'); document.querySelector('.no-print').classList.remove('hidden'); }

    function downloadImg() {
        html2canvas(document.querySelector("#boleta-impresion")).then(canvas => {
            const link = document.createElement('a');
            link.download = `Boleta_CAI.png`;
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    function editAl(id) {
        const al = data.find(x => x.id === id);
        document.getElementById('edit-id').value = id;
        document.getElementById('nc').value = al.code;
        document.getElementById('nn').value = al.name;
        document.getElementById('ng').value = al.grade;
    }
</script>
</body>
</html>
