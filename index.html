<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA CAI 2026 - FINAL</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --p: #1a5276; --bg: #f4f6f7; --orange: #e67e22; --dark: #2c3e50; --green: #27ae60; --red: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; font-size: 11px; }
        .header-app { display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px 20px; border-bottom: 4px solid var(--orange); position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tabs { display: flex; background: #1c2833; padding: 10px 10px 0; gap: 4px; overflow-x: auto; }
        .tab { padding: 10px 15px; color: #bdc3c7; cursor: pointer; border-radius: 6px 6px 0 0; background: rgba(255,255,255,0.05); border: none; font-size: 10px; white-space: nowrap; }
        .tab.active { background: var(--bg); color: var(--p); font-weight: bold; }
        .container { max-width: 1400px; margin: 15px auto; padding: 0 15px; }
        .table-card { background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); overflow-x: auto; padding: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 1200px; }
        th { background: #f8f9fa; padding: 12px 5px; border-bottom: 2px solid #dee2e6; color: var(--p); font-size: 9px; text-transform: uppercase; }
        td { padding: 8px 5px; border-bottom: 1px solid #eee; text-align: center; }
        .nota-input { width: 38px; padding: 5px; text-align: center; border: 1.5px solid #dcdde1; border-radius: 6px; font-weight: bold; }
        .asist-input { width: 30px; padding: 4px; text-align: center; border: 1px solid #ccc; border-radius: 4px; }
        .cond-input { width: 50px; padding: 4px; border-radius: 4px; border: 1px solid #ccc; font-weight: bold; }
        .obs-input { width: 150px; padding: 5px; border-radius: 4px; border: 1px solid #ccc; font-size: 9px; }
        .btn { padding: 8px 15px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; font-size: 10px; }
        .btn-add { background: var(--p); color: white; }
        .btn-del { background: var(--red); color: white; padding: 5px 8px; border-radius: 4px; }
        .btn-print { background: var(--green); color: white; }
        .status-aprobado { color: white; background: var(--green); padding: 4px 8px; border-radius: 4px; font-weight: bold; }
        .status-reprobado { color: white; background: var(--red); padding: 4px 8px; border-radius: 4px; font-weight: bold; }
        .hidden { display: none !important; }
        .login-box { background: white; padding: 40px; border-radius: 20px; width: 320px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        input, select { padding: 10px; border-radius: 8px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="login-screen" style="height:100vh; display:flex; align-items:center; justify-content:center; background:var(--dark);">
        <div class="login-box">
            <img src="https://i.ibb.co/Mkf051St/Logo-CAI.png" width="80">
            <h2 style="color:var(--p);">SISTEMA CAI 2026</h2>
            <input type="text" id="user" placeholder="Usuario">
            <input type="password" id="pass" placeholder="ContraseÃ±a">
            <button onclick="login()" style="width:100%; padding:12px; background:var(--orange); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">INGRESAR</button>
            <p id="error" style="color:red; font-size:10px; margin-top:10px;"></p>
        </div>
    </div>

    <div id="app" class="hidden">
        <div class="header-app">
            <div style="display:flex; align-items:center; gap:12px;">
                <img src="https://i.ibb.co/Mkf051St/Logo-CAI.png" height="50">
                <div>
                    <b style="font-size:16px; color:var(--p);">CAI - Colegio Amigos de Israel</b><br>
                    <span id="txt-grado" style="font-weight:bold; color:var(--dark)">---</span> | 
                    <span id="txt-rol" style="color:var(--orange); font-weight:700; font-size:10px;">ROL: ---</span>
                </div>
            </div>
            <div style="display:flex; gap:10px; align-items:center;">
                <select id="sel-grado" onchange="cambiarGrado()" style="margin-bottom:0; width:180px;"></select>
                <button id="btn-boletas" onclick="generarBoletas()" class="btn btn-print hidden">ðŸ“‘ BOLETAS</button>
                <button onclick="location.reload()" class="btn" style="background:var(--red); color:white;">SALIR</button>
            </div>
        </div>

        <nav id="nav-tabs" class="tabs"></nav>

        <div class="container">
            <div id="panel-admin" class="panel-registro hidden" style="background:white; padding:15px; border-radius:10px; margin-bottom:15px; border-left: 5px solid var(--p);">
                <b style="color:var(--p)">REGISTRO (ADMIN):</b>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <input type="text" id="reg-nie" placeholder="CÃ³digo" style="margin:0">
                    <input type="text" id="reg-ape" placeholder="Apellidos" style="margin:0">
                    <input type="text" id="reg-nom" placeholder="Nombres" style="margin:0">
                    <button onclick="matricular()" class="btn btn-add">MATRICULAR</button>
                </div>
            </div>

            <div class="table-card">
                <table><thead><tr id="table-head"></tr></thead><tbody id="table-body"></tbody></table>
            </div>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBmw9CdeBr1Z11v0ye4af-WACBeCL5FDc4",
        authDomain: "academica-bcb50.firebaseapp.com",
        projectId: "academica-bcb50",
        databaseURL: "https://academica-bcb50-default-rtdb.firebaseio.com/"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const MATERIAS = {
        "K4": ["InglÃ©s", "Biblia", "InformÃ¡tica", "Taller globalizador", "Taller de matemÃ¡tica", "Taller de expresiÃ³n grÃ¡fica", "Taller de lectoescritura", "Taller de deporte"],
        "K5": ["InglÃ©s", "Biblia", "InformÃ¡tica", "Taller globalizador", "Taller de expresiÃ³n grÃ¡fica", "Taller de matemÃ¡tica", "Taller de lectoescritura", "Taller de deporte"],
        "K6": ["InglÃ©s", "Biblia", "InformÃ¡tica", "Taller de conversaciÃ³n", "Taller de lectoescritura", "Taller de matemÃ¡ticas", "Taller de desarrollo", "EducaciÃ³n emocional", "Taller de deporte", "Taller de arte", "Taller de expresiÃ³n grÃ¡fica"],
        "1G": ["InglÃ©s", "Biblia", "InformÃ¡tica", "Finanzas y economia", "Taller de nÃºmeros", "Cuerpo y personalidad", "Taller de lectoescritura", "Cultura", "EducaciÃ³n y experiencia", "Escuela y sociedad", "Lectura"],
        "C1": ["InglÃ©s", "Biblia", "InformÃ¡tica", "Finanzas", "ComunicaciÃ³n", "NÃºmeros y formas", "Ciencia y tecnologÃ­a", "CiudadanÃ­a y valores", "Artes", "Desarrollo corporal"],
        "C2": ["InglÃ©s", "Biblia", "InformÃ¡tica", "Finanzas", "ComunicaciÃ³n y literatura", "AritmÃ©tica y Finanzas", "Ciencia y tecnologÃ­a", "CiudadanÃ­a y valores", "Artes", "Desarrollo corporal"],
        "C3": ["InglÃ©s", "Biblia", "InformÃ¡tica", "Finanzas", "Lengua y Literatura", "MatemÃ¡tica y datos", "Ciencia y tecnologÃ­a", "CiudadanÃ­a y valores", "EducaciÃ³n fÃ­sica"],
        "1B": ["InglÃ©s", "Biblia", "Lenguaje y literatura", "Precalculo", "Ciencia y tecnologÃ­a", "CiudadanÃ­a y valores", "EducaciÃ³n fÃ­sica", "Proyecto de vida", "Finanzas y economia", "Ciencias de la computaciÃ³n"],
        "2B": ["InglÃ©s", "Biblia", "Lenguaje y literatura", "Precalculo", "Ciencia y tecnologÃ­a", "CiudadanÃ­a y valores", "EducaciÃ³n fÃ­sica", "Orientacion para la vida", "Finanzas y economia", "Ciencias de la computaciÃ³n", "Seminario", "Curso de habilitacion laboral"]
    };

    const MESES_GENERAL = ["Febrero", "Marzo", "Trimestre 1", "Mayo", "Junio", "Trimestre 2", "Agosto", "Septiembre", "Trimestre 3"];
    const MESES_B = ["EvaluaciÃ³n 1", "EvaluaciÃ³n 2", "Periodo 1", "EvaluaciÃ³n 3", "EvaluaciÃ³n 4", "Periodo 2", "EvaluaciÃ³n 5", "EvaluaciÃ³n 6", "Periodo 3", "EvaluaciÃ³n 7", "EvaluaciÃ³n 8", "Periodo 4"];
    const MESES_INFANCIA = ["Trimestre 1", "Trimestre 2", "Trimestre 3"];

    const GRADOS_DATA = [
        {val:"K4", t:"Kinder 4 AÃ±os", cat:"infancia"}, {val:"K5", t:"Kinder 5 AÃ±os", cat:"infancia"}, {val:"K6", t:"Kinder 6 AÃ±os", cat:"infancia"}, {val:"1G", t:"1Â° Grado", cat:"infancia"},
        {val:"2G", t:"2Â° Grado", cat:"docente"}, {val:"3G", t:"3Â° Grado", cat:"docente"}, {val:"4G", t:"4Â° Grado", cat:"docente"},
        {val:"5G", t:"5Â° Grado", cat:"docente"}, {val:"6G", t:"6Â° Grado", cat:"docente"}, {val:"7G", t:"7Â° Grado", cat:"docente"},
        {val:"8G", t:"8Â° Grado", cat:"docente"}, {val:"9G", t:"9Â° Grado", cat:"docente"},
        {val:"1B", t:"1Â° Bachillerato", cat:"bachillerato"}, {val:"2B", t:"2Â° Bachillerato", cat:"bachillerato"}
    ];

    let currentRol = "", dataAlumnos = [], periodoActual = "", materiaVisualizada = "";

    function login() {
        const u = document.getElementById('user').value.toLowerCase(), p = document.getElementById('pass').value;
        if(u==='admin' && p==='admin2026') currentRol='admin';
        else if(u==='infancia' && p==='cai1') currentRol='infancia';
        else if(u==='docente' && p==='cai2') currentRol='docente';
        else if(u==='bachillerato' && p==='cai3') currentRol='bachillerato';
        
        if(currentRol) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('txt-rol').innerText = "ROL: " + currentRol.toUpperCase();
            if(currentRol==='admin') {
                document.getElementById('panel-admin').classList.remove('hidden');
                document.getElementById('btn-boletas').classList.remove('hidden');
            }
            cargarSelect();
        } else { document.getElementById('error').innerText = "Datos incorrectos"; }
    }

    function cargarSelect() {
        let options = "";
        const cats = {"infancia": "PRIMERA INFANCIA", "docente": "BÃSICA", "bachillerato": "BACHILLERATO"};
        Object.keys(cats).forEach(c => {
            if(currentRol === 'admin' || currentRol === c) {
                options += `<optgroup label="${cats[c]}">`;
                GRADOS_DATA.filter(g => g.cat === c).forEach(g => { options += `<option value="${g.val}">${g.t}</option>`; });
                options += `</optgroup>`;
            }
        });
        document.getElementById('sel-grado').innerHTML = options;
        cambiarGrado(); escucharDB();
    }

    function getCiclo(g) {
        if(["K4","K5","K6","1G"].includes(g)) return g;
        if(["2G","3G"].includes(g)) return "C1";
        if(["4G","5G","6G"].includes(g)) return "C2";
        if(["7G","8G","9G"].includes(g)) return "C3";
        return g;
    }

    function cambiarGrado() {
        const g = document.getElementById('sel-grado').value, ciclo = getCiclo(g);
        let lista = ["K4","K5","K6","1G"].includes(ciclo) ? MESES_INFANCIA : (ciclo.includes("B") ? MESES_B : MESES_GENERAL);
        periodoActual = lista[0]; 
        materiaVisualizada = MATERIAS[ciclo][0];
        document.getElementById('txt-grado').innerText = document.getElementById('sel-grado').options[document.getElementById('sel-grado').selectedIndex].text;
        document.getElementById('nav-tabs').innerHTML = lista.map(p => `<button class="tab ${p===periodoActual?'active':''}" onclick="setPeriodo('${p}', this)">${p}</button>`).join('');
        dibujar();
    }

    function setPeriodo(p, btn) {
        periodoActual = p; document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        btn.classList.add('active'); dibujar();
    }

    function calcular(n, p, g) {
        const v = { t:parseFloat(n.t)||0, l:parseFloat(n.l)||0, lc:parseFloat(n.lc)||0, int:parseFloat(n.int)||0, ex:parseFloat(n.ex)||0 };
        const c = getCiclo(g);
        let prom = 0;
        if(["K4","K5","K6","1G"].includes(c)) {
            prom = (p === "Trimestre 2") ? (v.t*0.15 + v.int*0.35 + v.ex*0.5) : (v.t*0.5 + v.ex*0.5);
        } else {
            const trim = p.includes("Trimestre") || p.includes("Periodo");
            prom = trim ? (v.t*0.1 + v.l*0.05 + v.lc*0.1 + v.int*0.35 + v.ex*0.4) : (v.t*0.25 + v.l*0.2 + v.lc*0.15 + v.ex*0.4);
        }
        return parseFloat(prom.toFixed(1));
    }

    function dibujar() {
        const g = document.getElementById('sel-grado').value, ciclo = getCiclo(g), gTxt = document.getElementById('sel-grado').options[document.getElementById('sel-grado').selectedIndex].text;
        const esp = ["K4","K5","K6","1G"].includes(ciclo), trim = periodoActual.includes("Trimestre") || periodoActual.includes("Periodo");
        const isAdmin = currentRol === 'admin';

        let h = `${isAdmin ? '<th>Borrar</th>' : ''}<th>CÃ“DIGO</th><th>Estudiante</th><th style="width:140px">Materia</th>`;
        if(esp) h += (periodoActual === "Trimestre 2") ? `<th>T15%</th><th>I35%</th><th>E50%</th>` : `<th>T50%</th><th>E50%</th>`;
        else h += trim ? `<th>T10</th><th>L5</th><th>LC10</th><th>I35</th><th>E40</th>` : `<th>T25</th><th>L20</th><th>LC15</th><th>E40</th>`;
        h += `<th>PROM</th><th>Cond.</th><th>Tar.</th><th>Ina.</th><th>Obs.</th>`;
        document.getElementById('table-head').innerHTML = h;

        let fil = dataAlumnos.filter(a => a.grado === gTxt).sort((a,b) => a.ape.localeCompare(b.ape)), b = "";
        fil.forEach(al => {
            const n = al.notas?.[periodoActual]?.[materiaVisualizada] || {};
            const as = al.asistencia?.[periodoActual] || { t:0, i:0 };
            const cond = al.conducta?.[periodoActual] || "MB";
            const obs = al.observaciones?.[periodoActual] || "";
            const prom = calcular(n, periodoActual, g);

            b += `<tr>
                ${isAdmin ? `<td><button class="btn btn-del" onclick="eliminarAlumno('${al.id}')">âœ–</button></td>` : ''}
                <td><b>${al.nie}</b></td>
                <td style="text-align:left">${al.ape}, ${al.nom}</td>
                <td><select onchange="materiaVisualizada=this.value; dibujar()">${MATERIAS[ciclo].map(m=>`<option ${m===materiaVisualizada?'selected':''}>${m}</option>`).join('')}</select></td>
                <td><input type="text" class="nota-input" value="${n.t||0}" onchange="save('${al.id}','t',this.value)"></td>`;
            
            if(!esp) b += `<td><input type="text" class="nota-input" value="${n.l||0}" onchange="save('${al.id}','l',this.value)"></td><td><input type="text" class="nota-input" value="${n.lc||0}" onchange="save('${al.id}','lc',this.value)"></td>`;
            if(trim || (esp && periodoActual === "Trimestre 2")) b += `<td><input type="text" class="nota-input" value="${n.int||0}" onchange="save('${al.id}','int',this.value)"></td>`;
            
            b += `<td><input type="text" class="nota-input" value="${n.ex||0}" onchange="save('${al.id}','ex',this.value)"></td>
                <td><span class="${prom >= (esp?6:7) ? 'status-aprobado':'status-reprobado'}">${prom}</span></td>
                <td><select class="cond-input" onchange="saveCond('${al.id}',this.value)">
                    <option value="B" ${cond==='B'?'selected':''}>B</option>
                    <option value="MB" ${cond==='MB'?'selected':''}>MB</option>
                    <option value="E" ${cond==='E'?'selected':''}>E</option>
                </select></td>
                <td><input type="number" class="asist-input" value="${as.t||0}" onchange="saveAsist('${al.id}','t',this.value)"></td>
                <td><input type="number" class="asist-input" value="${as.i||0}" onchange="saveAsist('${al.id}','i',this.value)"></td>
                <td><input type="text" class="obs-input" value="${obs}" onchange="saveObs('${al.id}',this.value)"></td>
            </tr>`;
        });
        document.getElementById('table-body').innerHTML = b;
    }

    function save(id, c, v) { db.ref(`alumnos/${id}/notas/${periodoActual}/${materiaVisualizada}/${c}`).set(parseFloat(v.replace(',','.')) || 0); }
    function saveAsist(id, c, v) { db.ref(`alumnos/${id}/asistencia/${periodoActual}/${c}`).set(parseInt(v) || 0); }
    function saveCond(id, v) { db.ref(`alumnos/${id}/conducta/${periodoActual}`).set(v); }
    function saveObs(id, v) { db.ref(`alumnos/${id}/observaciones/${periodoActual}`).set(v); }
    
    function matricular() {
        if(currentRol!=='admin') return;
        const nie = document.getElementById('reg-nie').value, ape = document.getElementById('reg-ape').value.toUpperCase(), nom = document.getElementById('reg-nom').value.toUpperCase();
        const grado = document.getElementById('sel-grado').options[document.getElementById('sel-grado').selectedIndex].text;
        if(nie && ape && nom) { db.ref('alumnos').push({ nie, ape, nom, grado }); alert("Listo"); }
    }
    
    function eliminarAlumno(id) { if(currentRol==='admin' && confirm("Â¿Borrar permanentemente?")) db.ref('alumnos/'+id).remove(); }
    function escucharDB() { db.ref('alumnos').on('value', snap => { const v = snap.val(); dataAlumnos = v ? Object.keys(v).map(k=>({id:k, ...v[k]})) : []; dibujar(); }); }

    function generarBoletas() {
        if(currentRol !== 'admin') return alert("Solo Admin");
        const val = document.getElementById('sel-grado').value, gTxt = document.getElementById('sel-grado').options[document.getElementById('sel-grado').selectedIndex].text;
        const ciclo = getCiclo(val), alumnos = dataAlumnos.filter(a => a.grado === gTxt);
        const esp = ["K4","K5","K6","1G"].includes(ciclo), trim = periodoActual.includes("Trimestre") || periodoActual.includes("Periodo");

        let win = window.open('', '_blank');
        let h = `<html><head><style>
            @page { size: letter; margin: 0; }
            body { font-family: 'Segoe UI', sans-serif; margin: 0; font-size: 7.5px; }
            .boleta { min-height: 48vh; padding: 5mm 10mm; border-bottom: 1px dashed #ccc; box-sizing: border-box; position: relative; page-break-inside: avoid; overflow: hidden; }
            .header { display: flex; align-items: center; border-bottom: 2px solid #1a5276; margin-bottom: 4px; }
            .info { display: grid; grid-template-columns: 2fr 1fr 1fr; background: #f2f2f2; padding: 3px; font-weight: bold; margin-bottom: 4px; font-size: 8.5px; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 3px; }
            th { background: #1a5276; color: white; padding: 2px; font-size: 7.5px; }
            td { border: 1px solid #ccc; padding: 1.5px; text-align: center; }
            .footer { margin-top: 10px; display: flex; justify-content: space-between; align-items: flex-end; }
            .sello-circular { width: 60px; height: 60px; border: 1.5px solid #1a5276; border-radius: 50%; display: flex; align-items: center; justify-content: center; text-align: center; font-size: 6px; color: #1a5276; font-weight: bold; }
            .firma { border-top: 1px solid #000; width: 200px; text-align: center; padding-top: 2px; font-weight: bold; font-size: 8px; }
        </style></head><body>`;

        alumnos.forEach((al, idx) => {
            const as = al.asistencia?.[periodoActual] || { t:0, i:0 };
            const cond = al.conducta?.[periodoActual] || "MB";
            const obs = al.observaciones?.[periodoActual] || "---";
            h += `<div class="boleta">
                <div class="header">
                    <img src="https://i.ibb.co/Mkf051St/Logo-CAI.png" height="30"> 
                    <h2 style="margin-left:15px; color:#1a5276; font-size:12px; margin-top:0; margin-bottom:0;">CAI COLEGIO AMIGOS DE ISRAEL - ${periodoActual.toUpperCase()}</h2>
                </div>
                <div class="info"><div>ALUMNO: ${al.ape} ${al.nom}</div><div>GRADO: ${gTxt}</div><div>NIE: ${al.nie}</div></div>
                <table><thead><tr><th style="text-align:left">MATERIA</th>`;
            if(esp) h += (periodoActual === "Trimestre 2") ? `<th>T15%</th><th>I35%</th><th>E50%</th>` : `<th>T50%</th><th>E50%</th>`;
            else h += trim ? `<th>T10</th><th>L5</th><th>LC10</th><th>I35</th><th>E40</th>` : `<th>T25</th><th>L20</th><th>LC15</th><th>E40</th>`;
            h += `<th>PROM</th></tr></thead><tbody>`;
            MATERIAS[ciclo].forEach(m => {
                const n = al.notas?.[periodoActual]?.[m] || {};
                const p = calcular(n, periodoActual, val);
                h += `<tr><td style="text-align:left; font-weight:bold;">${m}</td><td>${n.t||0}</td>`;
                if(!esp) h += `<td>${n.l||0}</td><td>${n.lc||0}</td>`;
                if(trim || (esp && periodoActual === "Trimestre 2")) h += `<td>${n.int||0}</td>`;
                h += `<td>${n.ex||0}</td><td style="background:#f9f9f9; font-weight:bold;">${p}</td></tr>`;
            });
            h += `</tbody></table>
                <div style="font-size:8px; margin-bottom:3px;"><b>CONDUCTA:</b> ${cond} | <b>TARDES:</b> ${as.t} | <b>INASISTENCIAS:</b> ${as.i}</div>
                <div style="border:1px solid #1a5276; padding:3px; height:25px; font-size:7.5px; overflow:hidden;"><b>OBSERVACIONES:</b> ${obs}</div>
                <div class="footer"><div class="sello-circular">SELLO CAI<br>2026</div><div class="firma">Rhina Elena Linares de Barahona<br>DIRECTORA</div></div>
            </div>`;
            if((idx+1)%2===0) h += `<div style="page-break-after:always;"></div>`;
        });
        win.document.write(h + "</body></html>"); win.document.close(); setTimeout(()=>win.print(),500);
    }
</script>
</body>
</html>
