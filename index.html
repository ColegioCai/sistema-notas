<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA CAI 2026 - CONTROL TOTAL</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root { --p: #1a5276; --bg: #f4f6f7; --red: #c0392b; --green: #27ae60; --orange: #e67e22; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; }
        .container { max-width: 1300px; margin: 20px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .uppercase { text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn { background: var(--p); color: white; border: none; padding: 10px; cursor: pointer; border-radius: 4px; font-weight: bold; margin: 2px; }
        .hidden { display: none !important; }
        
        /* Modal de Edici칩n de Notas */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 8px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }

        /* Tablas */
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        .row-docente { display: grid; grid-template-columns: 100px 1fr 80px 80px 60px 60px 60px; gap: 10px; padding: 10px; border-bottom: 1px solid #eee; align-items: center; }

        #boleta-impresion { width: 21cm; height: 13.5cm; padding: 1cm; background: white; border: 1px dashed #ccc; margin: 0 auto; }
        @media print { .no-print { display: none !important; } #container-boleta { display: block !important; } }
    </style>
</head>
<body>

    <div id="login-box" class="container" style="max-width:350px; margin-top:80px; text-align:center;">
        <h2 style="color:var(--p);">ACAD칄MICA CAI</h2>
        <input type="text" id="u" placeholder="Usuario">
        <input type="password" id="p" placeholder="Contrase침a">
        <select id="r">
            <option value="Admin">Administrador</option>
            <option value="Matematica">Matem치tica</option>
            <option value="Lenguaje">Lenguaje</option>
            <option value="Ciencias">Ciencias</option>
            <option value="Sociales">Sociales</option>
            <option value="Ingles">Ingl칠s</option>
        </select>
        <button class="btn" style="width:100%" onclick="login()">INGRESAR</button>
    </div>

    <div id="app" class="hidden">
        <div class="container no-print">
            <button onclick="location.reload()" style="float:right; background:var(--red);" class="btn">SALIR</button>
            <h3>Panel: <span id="user-tag" style="color:var(--orange)"></span></h3>

            <div id="admin-panel" class="hidden" style="background:#e8f8f5; padding:15px; border-radius:8px; border:1px solid #a3e4d7; margin-bottom: 20px;">
                <b>Registrar/Editar Alumno:</b>
                <div style="display:grid; grid-template-columns: 1fr 2fr 1.5fr 1fr; gap:10px; margin-top:10px;">
                    <input type="text" id="nc" placeholder="C칍DIGO" class="uppercase">
                    <input type="text" id="nn" placeholder="Nombre Completo">
                    <select id="ng">
                        <option value="Kinder">Kinder</option><option value="Parvularia">Parvularia</option>
                        <option value="1 Grado">1춿 Grado</option><option value="2 Grado">2춿 Grado</option>
                        <option value="3 Grado">3춿 Grado</option><option value="4 Grado">4춿 Grado</option>
                        <option value="5 Grado">5춿 Grado</option><option value="6 Grado">6춿 Grado</option>
                        <option value="7 Grado">7춿 Grado</option><option value="8 Grado">8춿 Grado</option>
                        <option value="9 Grado">9춿 Grado</option><option value="1 A침o">1춿 A침o Bach</option>
                        <option value="2 A침o">2춿 A침o Bach</option>
                    </select>
                    <button class="btn" style="background:var(--green);" onclick="saveAlumno()">GUARDAR</button>
                </div>
                <input type="hidden" id="edit-id">
            </div>

            <div style="display:grid; grid-template-columns: 2fr 1fr; gap:15px; margin-bottom: 10px;">
                <input type="text" id="search" placeholder="游댌 Buscar..." onkeyup="draw()" class="uppercase">
                <select id="filter-grado" onchange="draw()">
                    <option value="TODOS">Todos los Grados</option>
                    <option value="Kinder">Kinder</option><option value="Parvularia">Parvularia</option>
                    <option value="1 Grado">1춿 Grado</option><option value="2 Grado">2춿 Grado</option>
                    <option value="3 Grado">3춿 Grado</option><option value="4 Grado">4춿 Grado</option>
                    <option value="5 Grado">5춿 Grado</option><option value="6 Grado">6춿 Grado</option>
                    <option value="7 Grado">7춿 Grado</option><option value="8 Grado">8춿 Grado</option>
                    <option value="9 Grado">9춿 Grado</option><option value="1 A침o">1춿 A침o Bach</option>
                    <option value="2 A침o">2춿 A침o Bach</option>
                </select>
            </div>
            
            <div id="view-admin" class="hidden">
                <table>
                    <thead><tr style="background:#eee"><th>C칍DIGO</th><th>ALUMNO</th><th>GRADO</th><th>ACCIONES</th></tr></thead>
                    <tbody id="list-admin"></tbody>
                </table>
            </div>

            <div id="view-docente" class="hidden">
                <div class="row-docente" style="background:var(--p); color:white; font-weight:bold;">
                    <span>C칍DIGO</span><span>ALUMNO</span><span>60%</span><span>40%</span><span>ASIS</span><span>INAS</span><span>PERM</span>
                </div>
                <div id="list-docente"></div>
            </div>
        </div>

        <div id="modal-notas" class="modal hidden">
            <div class="modal-content">
                <h3 id="modal-title" style="color:var(--p); margin-top:0;">Editar Notas del Alumno</h3>
                <div id="modal-body"></div>
                <div style="text-align:right; margin-top:20px;">
                    <button class="btn" style="background:var(--green)" onclick="closeModal()">FINALIZAR EDICI칍N</button>
                </div>
            </div>
        </div>

        <div id="container-boleta" class="hidden">
            <div class="no-print" style="text-align:center; padding:15px;">
                <button class="btn" style="background:var(--green)" onclick="downloadImg()">DESCARGAR IMAGEN</button>
                <button class="btn" onclick="window.print()">IMPRIMIR</button>
                <button class="btn" style="background:var(--red)" onclick="closeBoleta()">VOLVER</button>
            </div>
            <div id="boleta-impresion">
                <div style="text-align:center; border-bottom:2px solid var(--p);">
                    <h2 style="margin:0">COLEGIO ACAD칄MICO INTEGRAL (CAI)</h2>
                    <p>REPORTE 2026</p>
                </div>
                <div id="boleta-content"></div>
            </div>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBmw9CdeBr1Z11v0ye4af-WACBeCL5FDc4",
        authDomain: "academica-bcb50.firebaseapp.com",
        projectId: "academica-bcb50",
        databaseURL: "https://academica-bcb50-default-rtdb.firebaseio.com/",
        storageBucket: "academica-bcb50.firebasestorage.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let role = ""; let data = [];

    function login() {
        const creds = { "Admin":["Registro","Admin"], "Matematica":["prof_mate","cai2026"], "Lenguaje":["prof_lenguaje","cai2026"], "Ciencias":["prof_ciencias","cai2026"], "Sociales":["prof_sociales","cai2026"], "Ingles":["prof_ingles","cai2026"] };
        const u = document.getElementById('u').value; const p = document.getElementById('p').value; const r = document.getElementById('r').value;
        if(creds[r] && u === creds[r][0] && p === creds[r][1]) {
            role = r; document.getElementById('login-box').classList.add('hidden'); document.getElementById('app').classList.remove('hidden');
            document.getElementById('user-tag').innerText = role.toUpperCase();
            if(role === "Admin") { document.getElementById('admin-panel').classList.remove('hidden'); document.getElementById('view-admin').classList.remove('hidden'); }
            else { document.getElementById('view-docente').classList.remove('hidden'); }
            db.ref('alumnos').on('value', s => { const val = s.val(); data = val ? Object.keys(val).map(k=>({id:k,...val[k]})) : []; draw(); });
        } else alert("Acceso Incorrecto");
    }

    function saveAlumno() {
        const id = document.getElementById('edit-id').value;
        const al = { code: document.getElementById('nc').value.toUpperCase(), name: document.getElementById('nn').value, grade: document.getElementById('ng').value };
        if(!al.code || !al.name) return;
        if(id) db.ref('alumnos/'+id).update(al);
        else {
            al.notas = { Matematica:{a:0,e:0}, Lenguaje:{a:0,e:0}, Ciencias:{a:0,e:0}, Sociales:{a:0,e:0}, Ingles:{a:0,e:0} };
            al.asist = { Matematica:{as:0,in:0,pe:0}, Lenguaje:{as:0,in:0,pe:0}, Ciencias:{as:0,in:0,pe:0}, Sociales:{as:0,in:0,pe:0}, Ingles:{as:0,in:0,pe:0} };
            al.faltas = ""; db.ref('alumnos').push(al);
        }
        document.getElementById('edit-id').value=""; document.getElementById('nc').value=""; document.getElementById('nn').value="";
    }

    function adminUpdate(id, path, val) { db.ref(`alumnos/${id}/${path}`).set(val); }

    function draw() {
        const s = document.getElementById('search').value.toUpperCase();
        const g = document.getElementById('filter-grado').value;
        const filtered = data.filter(a => (a.name.toUpperCase().includes(s) || a.code.includes(s)) && (g === "TODOS" || a.grade === g));

        if(role === "Admin") {
            const list = document.getElementById('list-admin'); list.innerHTML = "";
            filtered.forEach(al => {
                list.innerHTML += `<tr><td>${al.code}</td><td>${al.name}</td><td>${al.grade}</td>
                <td>
                    <button class="btn" style="padding:5px; background:var(--green)" onclick="openModal('${al.id}')">游닇 NOTAS</button>
                    <button class="btn" style="padding:5px" onclick="generateBoleta('${al.id}')">游늯</button>
                    <button class="btn" style="padding:5px; background:var(--orange)" onclick="editAl('${al.id}')">九勇</button>
                </td></tr>`;
            });
        } else {
            const list = document.getElementById('list-docente'); list.innerHTML = "";
            filtered.forEach(al => {
                const n = al.notas[role] || {a:0,e:0}; const as = al.asist[role] || {as:0,in:0,pe:0};
                list.innerHTML += `<div class="row-docente">
                    <span>${al.code}</span><span>${al.name}</span>
                    <input type="number" value="${n.a}" onchange="db.ref('alumnos/${al.id}/notas/${role}/a').set(parseFloat(this.value)||0)">
                    <input type="number" value="${n.e}" onchange="db.ref('alumnos/${al.id}/notas/${role}/e').set(parseFloat(this.value)||0)">
                    <input type="number" value="${as.as}" onchange="db.ref('alumnos/${al.id}/asist/${role}/as').set(parseInt(this.value)||0)">
                    <input type="number" value="${as.in}" onchange="db.ref('alumnos/${al.id}/asist/${role}/in').set(parseInt(this.value)||0)">
                    <input type="number" value="${as.pe}" onchange="db.ref('alumnos/${al.id}/asist/${role}/pe').set(parseInt(this.value)||0)">
                </div>`;
            });
        }
    }

    function openModal(id) {
        const al = data.find(x => x.id === id);
        document.getElementById('modal-title').innerText = `EDITAR: ${al.name}`;
        let html = `<h4>Calificaciones y Asistencia</h4>`;
        ["Matematica","Lenguaje","Ciencias","Sociales","Ingles"].forEach(m => {
            const n = al.notas[m]; const as = al.asist[m];
            html += `<div style="border:1px solid #ddd; padding:10px; margin-bottom:10px; border-radius:5px;">
                <b style="color:var(--p)">${m.toUpperCase()}</b>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <div><small>60%</small><input type="number" value="${n.a}" onchange="adminUpdate('${id}','notas/${m}/a', parseFloat(this.value))"></div>
                    <div><small>40%</small><input type="number" value="${n.e}" onchange="adminUpdate('${id}','notas/${m}/e', parseFloat(this.value))"></div>
                    <div><small>Asis</small><input type="number" value="${as.as}" onchange="adminUpdate('${id}','asist/${m}/as', parseInt(this.value))"></div>
                </div>
            </div>`;
        });
        html += `<h4>Conducta / Faltas</h4><textarea onchange="adminUpdate('${id}','faltas', this.value)">${al.faltas || ''}</textarea>`;
        document.getElementById('modal-body').innerHTML = html;
        document.getElementById('modal-notas').classList.remove('hidden');
    }

    function closeModal() { document.getElementById('modal-notas').classList.add('hidden'); }
    function generateBoleta(id) {
        const al = data.find(x => x.id === id); let total = 0; let rows = "";
        ["Matematica","Lenguaje","Ciencias","Sociales","Ingles"].forEach(m => {
            const n = al.notas[m]; const p = (n.a*0.6+n.e*0.4); total += p;
            rows += `<tr><td>${m}</td><td>${n.a}</td><td>${n.e}</td><td>${p.toFixed(1)}</td></tr>`;
        });
        document.getElementById('boleta-content').innerHTML = `<p><b>${al.name}</b> | ${al.grade}</p>
            <table border="1"><tr><th>MATERIA</th><th>60%</th><th>40%</th><th>PROM</th></tr>${rows}
            <tr style="background:#eee"><td><b>FINAL</b></td><td colspan="3"><b>${(total/5).toFixed(2)}</b></td></tr></table>
            <p><small>OBS: ${al.faltas || 'Ninguna'}</small></p>`;
        document.getElementById('container-boleta').classList.remove('hidden');
        document.querySelector('.no-print').classList.add('hidden');
    }
    function downloadImg() { html2canvas(document.querySelector("#boleta-impresion")).then(canvas => { const link = document.createElement('a'); link.download = `Boleta.png`; link.href = canvas.toDataURL(); link.click(); }); }
    function closeBoleta() { document.getElementById('container-boleta').classList.add('hidden'); document.querySelector('.no-print').classList.remove('hidden'); }
    function editAl(id) { const al = data.find(x => x.id === id); document.getElementById('edit-id').value = id; document.getElementById('nc').value = al.code; document.getElementById('nn').value = al.name; document.getElementById('ng').value = al.grade; }
</script>
</body>
</html>
