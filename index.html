<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ACAD칄MICA CAI - Gesti칩n de Notas</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #1a5276; --bg: #f2f4f4; --success: #219150; --pdf: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; }
        #login-screen { height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #1a5276 0%, #2980b9 100%); }
        .login-card { background: white; padding: 30px; border-radius: 12px; width: 320px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .container { max-width: 950px; margin: 20px auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .tabs { display: flex; max-width: 950px; margin: 20px auto 0; gap: 4px; overflow-x: auto; padding: 0 10px; }
        .tab-button { padding: 12px 20px; border: none; background: #ccd1d1; cursor: pointer; font-weight: bold; border-radius: 8px 8px 0 0; }
        .tab-button.active { background: white; color: var(--primary); border-bottom: 3px solid var(--primary); }
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }
        .card { border: 1px solid #e5e8e8; padding: 15px; border-radius: 8px; margin-bottom: 10px; background: white; }
        .grid-notas { display: grid; grid-template-columns: 1fr 2fr 1.5fr 1fr 1fr 1fr; gap: 10px; align-items: center; }
        input { padding: 8px; border: 1px solid #bdc3c7; border-radius: 4px; width: 100%; box-sizing: border-box; }
        input:disabled { background-color: #f0f3f4; color: #7f8c8d; cursor: not-allowed; border: 1px solid #d5dbdb; }
        .search-box { width: 100%; padding: 12px; margin-bottom: 20px; border: 2px solid var(--primary); border-radius: 6px; font-size: 16px; }
        button { cursor: pointer; font-weight: bold; border: none; border-radius: 4px; padding: 10px; }
        .btn-logout { background: #e74c3c; color: white; float: right; padding: 5px 15px; }
        .label-grado { font-weight: bold; color: #1a5276; font-size: 11px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <h2 style="color:var(--primary)">ACAD칄MICA CAI</h2>
            <input type="text" id="user-input" placeholder="Usuario"><br><br>
            <input type="password" id="pass-input" placeholder="Contrase침a"><br><br>
            <select id="materia-select" style="width:100%; padding:10px; border-radius:4px;">
                <option value="Admin">Administrador</option>
                <option value="Lenguaje">Materia: Lenguaje</option>
                <option value="Matematica">Materia: Matem치tica</option>
                <option value="Ciencias">Materia: Ciencias</option>
                <option value="Sociales">Materia: Sociales</option>
            </select><br><br>
            <button onclick="intentarLogin()" style="width:100%; background:var(--primary); color:white;">INGRESAR</button>
            <p id="error-msg" style="color:red; display:none; font-size:12px; margin-top:10px;">Usuario o clave incorrecta</p>
        </div>
    </div>

    <div id="main-app" style="display:none;">
        <div style="max-width:950px; margin: 10px auto; padding: 0 20px;">
            <button onclick="location.reload()" class="btn-logout">CERRAR SESI칍N</button>
            <p>Panel: <b id="display-user"></b> | <b>ACAD칄MICA CAI</b></p>
        </div>

        <div class="tabs" id="tab-bar"></div>

        <div id="content-area">
            <div id="tab-registro" class="tab-content">
                <h3>Consolidado General</h3>
                <div id="admin-controls" style="display:none;" class="card">
                    <div style="display:grid; grid-template-columns: 1fr 2fr 1fr auto; gap:10px;">
                        <input type="text" id="reg-code" placeholder="C칍DIGO" oninput="this.value = this.value.toUpperCase()">
                        <input type="text" id="reg-name" placeholder="Nombre Alumno">
                        <input type="text" id="reg-grade" placeholder="Grado">
                        <button onclick="registrarAlumno()" style="background:var(--primary); color:white;">A칌ADIR</button>
                    </div>
                </div>
                <button onclick="exportarExcel()" style="background:var(--success); color:white; margin:10px 0;">游늵 EXPORTAR A EXCEL</button>
                <input type="text" id="search-main" class="search-box" placeholder="游댌 Buscar por nombre o c칩digo..." onkeyup="renderData()">
                <div id="lista-alumnos-final"></div>
            </div>
            
            <div id="subject-container"></div>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBmw9CdeBr1Z11v0ye4af-WACBeCL5FDc4",
        authDomain: "academica-bcb50.firebaseapp.com",
        projectId: "academica-bcb50",
        databaseURL: "https://academica-bcb50-default-rtdb.firebaseio.com/",
        storageBucket: "academica-bcb50.firebasestorage.app"
    };
    
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let sessionRole = "";
    let alumnosData = [];
    const materias = ["Lenguaje", "Matematica", "Ciencias", "Sociales"];
    const credenciales = {
        "Admin": { user: "Registro", pass: "Admin" },
        "Lenguaje": { user: "prof_lenguaje", pass: "cai2026" },
        "Matematica": { user: "prof_mate", pass: "cai2026" },
        "Ciencias": { user: "prof_ciencias", pass: "cai2026" },
        "Sociales": { user: "prof_sociales", pass: "cai2026" }
    };

    function intentarLogin() {
        const u = document.getElementById('user-input').value;
        const p = document.getElementById('pass-input').value;
        const r = document.getElementById('materia-select').value;
        
        if (credenciales[r] && u === credenciales[r].user && p === credenciales[r].pass) {
            sessionRole = r;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            document.getElementById('display-user').innerText = r;
            if(r === "Admin") document.getElementById('admin-controls').style.display = 'block';
            setupTabs();
            cargarDatos();
        } else {
            document.getElementById('error-msg').style.display = 'block';
        }
    }

    function setupTabs() {
        const tabBar = document.getElementById('tab-bar');
        const subCont = document.getElementById('subject-container');
        tabBar.innerHTML = `<button class="tab-button active" onclick="switchTab('tab-registro', this)">GENERAL</button>`;
        
        materias.forEach(m => {
            const btn = document.createElement('button');
            const locked = (sessionRole !== "Admin" && sessionRole !== m);
            btn.className = `tab-button ${locked ? 'locked' : ''}`;
            btn.innerText = m.toUpperCase();
            if(!locked) btn.onclick = () => switchTab('tab-' + m, btn);
            tabBar.appendChild(btn);

            subCont.innerHTML += `
                <div id="tab-${m}" class="tab-content">
                    <h3>Materia: ${m}</h3>
                    <input type="text" id="search-${m}" class="search-box" placeholder="游댌 Buscar en ${m}..." onkeyup="renderData()">
                    <div class="grid-notas" style="font-weight:bold; background:#ddd; padding:10px; border-radius:5px; margin-bottom:10px;">
                        <span>C칍DIGO</span><span>NOMBRE</span><span>GRADO</span><span>ACT(60%)</span><span>EXA(40%)</span><span>PROM</span>
                    </div>
                    <div id="lista-${m}"></div>
                </div>`;
        });
    }

    function switchTab(id, btn) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
    }

    function cargarDatos() {
        database.ref('alumnos').on('value', (snapshot) => {
            const data = snapshot.val();
            alumnosData = data ? Object.keys(data).map(key => ({id: key, ...data[key]})) : [];
            renderData();
        });
    }

    function registrarAlumno() {
        const code = document.getElementById('reg-code').value.trim();
        const name = document.getElementById('reg-name').value.trim();
        const grade = document.getElementById('reg-grade').value.trim();
        if(!code || !name) return alert("C칩digo y Nombre son obligatorios");
        
        database.ref('alumnos').push({
            code: code, name: name, grade: grade,
            notas: { Lenguaje: {act:0, exa:0}, Matematica: {act:0, exa:0}, Ciencias: {act:0, exa:0}, Sociales: {act:0, exa:0} }
        });
        document.getElementById('reg-code').value = "";
        document.getElementById('reg-name').value = "";
        document.getElementById('reg-grade').value = "";
    }

    function actualizarNota(alId, materia, campo, valor) {
        if(sessionRole !== "Admin") return;
        database.ref(`alumnos/${alId}/notas/${materia}/${campo}`).set(parseFloat(valor) || 0);
    }

    function renderData() {
        const isAdm = (sessionRole === "Admin");
        
        // Render General
        const sMain = document.getElementById('search-main').value.toLowerCase();
        const resCont = document.getElementById('lista-alumnos-final');
        resCont.innerHTML = "";
        alumnosData.filter(a => a.name.toLowerCase().includes(sMain) || a.code.toLowerCase().includes(sMain)).forEach(al => {
            let sum = 0;
            materias.forEach(m => { 
                const n = al.notas[m] || {act:0, exa:0}; 
                sum += (n.act * 0.6 + n.exa * 0.4); 
            });
            const prom = (sum / 4).toFixed(2);
            resCont.innerHTML += `
                <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                    <span><b>[${al.code}]</b> ${al.name} <span class="label-grado">GRADO: ${al.grade}</span></span>
                    <b style="background:${prom >= 7 ? '#219150' : '#e74c3c'}; color:white; padding:4px 10px; border-radius:4px;">${prom}</b>
                </div>`;
        });

        // Render Materias
        materias.forEach(m => {
            const container = document.getElementById(`lista-${m}`);
            if(!container) return;
            const sSub = document.getElementById(`search-${m}`).value.toLowerCase();
            container.innerHTML = "";
            alumnosData.filter(a => a.name.toLowerCase().includes(sSub) || a.code.toLowerCase().includes(sSub)).forEach(al => {
                const n = al.notas[m] || {act:0, exa:0};
                const p = (n.act * 0.6 + n.exa * 0.4).toFixed(2);
                container.innerHTML += `
                    <div class="grid-notas card">
                        <span style="font-weight:bold;">${al.code}</span>
                        <span style="font-size:14px;">${al.name}</span>
                        <span class="label-grado">GRADO: ${al.grade}</span>
                        <input type="number" value="${n.act}" onchange="actualizarNota('${al.id}','${m}','act',this.value)" ${isAdm ? '' : 'disabled'} step="0.1">
                        <input type="number" value="${n.exa}" onchange="actualizarNota('${al.id}','${m}','exa',this.value)" ${isAdm ? '' : 'disabled'} step="0.1">
                        <b style="text-align:center; color:${p >= 7 ? 'green':'red'}">${p}</b>
                    </div>`;
            });
        });
    }

    function exportarExcel() {
        const data = alumnosData.map(al => {
            let row = { "COD": al.code, "NOMBRE": al.name, "GRADO": al.grade };
            let total = 0;
            materias.forEach(m => {
                const n = al.notas[m] || {act:0, exa:0};
                const p = (n.act * 0.6 + n.exa * 0.4);
                row[m.toUpperCase()] = p.toFixed(2);
                total += p;
            });
            row["PROMEDIO"] = (total / 4).toFixed(2);
            return row;
        });
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Notas");
        XLSX.writeFile(wb, "Reporte_CAI.xlsx");
    }
</script>
</body>
</html>
