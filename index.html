<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA CAI 2026 - GESTI칍N POR GRADOS</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root { --p: #1a5276; --bg: #f4f6f7; --red: #c0392b; --green: #27ae60; --orange: #e67e22; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; }
        .container { max-width: 1300px; margin: 20px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .uppercase { text-transform: uppercase; }
        input, select { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn { background: var(--p); color: white; border: none; padding: 10px; cursor: pointer; border-radius: 4px; font-weight: bold; margin: 2px; }
        .hidden { display: none !important; }
        
        /* Tabla y Filas Docente */
        .tabla-docente { width: 100%; margin-top: 10px; border-collapse: collapse; }
        .header-docente { display: grid; grid-template-columns: 100px 1fr 80px 80px 70px 70px 70px; gap: 10px; background: var(--p); color: white; padding: 12px; font-weight: bold; border-radius: 5px 5px 0 0; }
        .row-docente { display: grid; grid-template-columns: 100px 1fr 80px 80px 70px 70px 70px; gap: 10px; padding: 8px; border-bottom: 1px solid #eee; align-items: center; }
        .row-docente:hover { background: #f9f9f9; }

        /* Boleta */
        #boleta-impresion { width: 21cm; height: 13.5cm; padding: 1cm; background: white; border: 1px dashed #ccc; margin: 0 auto; }
        @media print { .no-print { display: none !important; } #container-boleta { display: block !important; } @page { size: letter landscape; margin: 0; } }
    </style>
</head>
<body>

    <div id="login-box" class="container" style="max-width:350px; margin-top:80px; text-align:center;">
        <h2 style="color:var(--p);">ACAD칄MICA CAI</h2>
        <input type="text" id="u" placeholder="Usuario">
        <input type="password" id="p" placeholder="Contrase침a">
        <select id="r">
            <option value="Admin">Administrador</option>
            <option value="Matematica">Matem치tica</option>
            <option value="Lenguaje">Lenguaje</option>
            <option value="Ciencias">Ciencias</option>
            <option value="Sociales">Sociales</option>
            <option value="Ingles">Ingl칠s</option>
        </select>
        <button class="btn" style="width:100%" onclick="login()">INGRESAR AL PANEL</button>
    </div>

    <div id="app" class="hidden">
        <div class="container no-print">
            <button onclick="location.reload()" style="float:right; background:var(--red);" class="btn">SALIR</button>
            <h3>Panel de Control: <span id="user-tag" style="color:var(--orange)"></span></h3>

            <div id="admin-panel" class="hidden" style="background:#e8f8f5; padding:15px; border-radius:8px; border:1px solid #a3e4d7; margin-bottom: 20px;">
                <b>Registrar Alumno:</b>
                <div style="display:grid; grid-template-columns: 1fr 2fr 1.5fr 1fr; gap:10px; margin-top:10px;">
                    <input type="text" id="nc" placeholder="C칍DIGO" class="uppercase">
                    <input type="text" id="nn" placeholder="Nombre Completo">
                    <select id="ng">
                        <option value="Kinder">Kinder</option><option value="Parvularia">Parvularia</option>
                        <option value="1 Grado">1춿 Grado</option><option value="2 Grado">2춿 Grado</option>
                        <option value="3 Grado">3춿 Grado</option><option value="4 Grado">4춿 Grado</option>
                        <option value="5 Grado">5춿 Grado</option><option value="6 Grado">6춿 Grado</option>
                        <option value="7 Grado">7춿 Grado</option><option value="8 Grado">8춿 Grado</option>
                        <option value="9 Grado">9춿 Grado</option><option value="1 A침o">1춿 A침o Bach</option>
                        <option value="2 A침o">2춿 A침o Bach</option>
                    </select>
                    <button class="btn" style="background:var(--green);" onclick="saveAlumno()">GUARDAR</button>
                </div>
                <input type="hidden" id="edit-id">
            </div>

            <div style="display:grid; grid-template-columns: 2fr 1fr; gap:15px; margin-bottom: 10px;">
                <input type="text" id="search" placeholder="游댌 Buscar por nombre o c칩digo..." onkeyup="draw()" class="uppercase">
                <select id="filter-grado" onchange="draw()">
                    <option value="TODOS">--- Ver Todos los Grados ---</option>
                    <option value="Kinder">Kinder</option><option value="Parvularia">Parvularia</option>
                    <option value="1 Grado">1춿 Grado</option><option value="2 Grado">2춿 Grado</option>
                    <option value="3 Grado">3춿 Grado</option><option value="4 Grado">4춿 Grado</option>
                    <option value="5 Grado">5춿 Grado</option><option value="6 Grado">6춿 Grado</option>
                    <option value="7 Grado">7춿 Grado</option><option value="8 Grado">8춿 Grado</option>
                    <option value="9 Grado">9춿 Grado</option><option value="1 A침o">1춿 A침o Bach</option>
                    <option value="2 A침o">2춿 A침o Bach</option>
                </select>
            </div>
            
            <div id="view-admin" class="hidden">
                <table style="width:100%; border-collapse: collapse;">
                    <thead><tr style="background:#eee"><th>C칍DIGO</th><th>ALUMNO</th><th>GRADO</th><th>ACCIONES</th></tr></thead>
                    <tbody id="list-admin" style="text-align:center"></tbody>
                </table>
            </div>

            <div id="view-docente" class="hidden">
                <div class="header-docente">
                    <span>C칍DIGO</span><span>ALUMNO</span><span>60%</span><span>40%</span><span>ASIS</span><span>INAS</span><span>PERM</span>
                </div>
                <div id="list-docente"></div>
            </div>
        </div>

        <div id="container-boleta" class="hidden">
            <div class="no-print" style="text-align:center; padding:15px;">
                <button class="btn" style="background:var(--green)" onclick="downloadImg()">DESCARGAR IMAGEN</button>
                <button class="btn" onclick="window.print()">IMPRIMIR</button>
                <button class="btn" style="background:var(--red)" onclick="closeBoleta()">VOLVER</button>
            </div>
            <div id="boleta-impresion">
                <div style="text-align:center; border-bottom:2px solid var(--p);">
                    <h2 style="margin:0">COLEGIO ACAD칄MICO INTEGRAL (CAI)</h2>
                    <p style="margin:5px">REPORTE DE CALIFICACIONES 2026</p>
                </div>
                <div id="boleta-content" style="margin-top:15px"></div>
            </div>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBmw9CdeBr1Z11v0ye4af-WACBeCL5FDc4",
        authDomain: "academica-bcb50.firebaseapp.com",
        projectId: "academica-bcb50",
        databaseURL: "https://academica-bcb50-default-rtdb.firebaseio.com/",
        storageBucket: "academica-bcb50.firebasestorage.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let role = ""; let data = [];

    function login() {
        const creds = { "Admin":["Registro","Admin"], "Matematica":["prof_mate","cai2026"], "Lenguaje":["prof_lenguaje","cai2026"], "Ciencias":["prof_ciencias","cai2026"], "Sociales":["prof_sociales","cai2026"], "Ingles":["prof_ingles","cai2026"] };
        const u = document.getElementById('u').value; const p = document.getElementById('p').value; const r = document.getElementById('r').value;
        if(creds[r] && u === creds[r][0] && p === creds[r][1]) {
            role = r; document.getElementById('login-box').classList.add('hidden'); document.getElementById('app').classList.remove('hidden');
            document.getElementById('user-tag').innerText = role.toUpperCase();
            if(role === "Admin") { document.getElementById('admin-panel').classList.remove('hidden'); document.getElementById('view-admin').classList.remove('hidden'); }
            else { document.getElementById('view-docente').classList.remove('hidden'); }
            db.ref('alumnos').on('value', s => { const val = s.val(); data = val ? Object.keys(val).map(k=>({id:k,...val[k]})) : []; draw(); });
        } else alert("Credenciales Incorrectas");
    }

    function saveAlumno() {
        const id = document.getElementById('edit-id').value;
        const al = { code: document.getElementById('nc').value.toUpperCase(), name: document.getElementById('nn').value, grade: document.getElementById('ng').value };
        if(!al.code || !al.name) return;
        if(id) db.ref('alumnos/'+id).update(al);
        else {
            al.notas = { Matematica:{a:0,e:0}, Lenguaje:{a:0,e:0}, Ciencias:{a:0,e:0}, Sociales:{a:0,e:0}, Ingles:{a:0,e:0} };
            al.asist = { Matematica:{as:0,in:0,pe:0}, Lenguaje:{as:0,in:0,pe:0}, Ciencias:{as:0,in:0,pe:0}, Sociales:{as:0,in:0,pe:0}, Ingles:{as:0,in:0,pe:0} };
            al.faltas = ""; db.ref('alumnos').push(al);
        }
        document.getElementById('edit-id').value=""; document.getElementById('nc').value=""; document.getElementById('nn').value="";
    }

    function updateNota(id, campo, val) { db.ref(`alumnos/${id}/notas/${role}/${campo}`).set(parseFloat(val) || 0); }
    function updateAsist(id, campo, val) { db.ref(`alumnos/${id}/asist/${role}/${campo}`).set(parseInt(val) || 0); }

    function draw() {
        const s = document.getElementById('search').value.toUpperCase();
        const g = document.getElementById('filter-grado').value;
        
        const filtered = data.filter(a => {
            const matchesSearch = a.name.toUpperCase().includes(s) || a.code.includes(s);
            const matchesGrade = (g === "TODOS" || a.grade === g);
            return matchesSearch && matchesGrade;
        });

        if(role === "Admin") {
            const list = document.getElementById('list-admin'); list.innerHTML = "";
            filtered.forEach(al => {
                list.innerHTML += `<tr style="border-bottom:1px solid #eee"><td>${al.code}</td><td>${al.name}</td><td>${al.grade}</td>
                <td><button class="btn" style="padding:5px" onclick="generateBoleta('${al.id}')">游늯</button>
                <button class="btn" style="padding:5px; background:var(--orange)" onclick="editAl('${al.id}')">九勇</button></td></tr>`;
            });
        } else {
            const list = document.getElementById('list-docente'); list.innerHTML = "";
            filtered.forEach(al => {
                const n = al.notas[role] || {a:0,e:0}; const as = al.asist[role] || {as:0,in:0,pe:0};
                list.innerHTML += `<div class="row-docente">
                    <span style="font-weight:bold">${al.code}</span><span style="font-size:13px">${al.name}</span>
                    <input type="number" value="${n.a}" onchange="updateNota('${al.id}','a',this.value)">
                    <input type="number" value="${n.e}" onchange="updateNota('${al.id}','e',this.value)">
                    <input type="number" value="${as.as}" onchange="updateAsist('${al.id}','as',this.value)">
                    <input type="number" value="${as.in}" onchange="updateAsist('${al.id}','in',this.value)">
                    <input type="number" value="${as.pe}" onchange="updateAsist('${al.id}','pe',this.value)">
                </div>`;
            });
        }
    }

    function generateBoleta(id) {
        const al = data.find(x => x.id === id); let total = 0; let rows = "";
        ["Matematica","Lenguaje","Ciencias","Sociales","Ingles"].forEach(m => {
            const n = al.notas[m]; const p = (n.a*0.6+n.e*0.4); total += p;
            rows += `<tr><td>${m}</td><td>${n.a}</td><td>${n.e}</td><td>${p.toFixed(1)}</td></tr>`;
        });
        document.getElementById('boleta-content').innerHTML = `
            <p><b>ALUMNO:</b> ${al.name} &nbsp;&nbsp; <b>GRADO:</b> ${al.grade}</p>
            <table style="width:100%; border-collapse:collapse; text-align:center;" border="1">
                <tr style="background:#f2f2f2"><th>MATERIA</th><th>60%</th><th>40%</th><th>PROM</th></tr>${rows}
                <tr style="background:#eee"><td colspan="3"><b>PROMEDIO FINAL</b></td><td><b>${(total/5).toFixed(2)}</b></td></tr>
            </table><p><b>OBSERVACIONES:</b> ${al.faltas || 'Ninguna'}</p>`;
        document.getElementById('container-boleta').classList.remove('hidden');
        document.querySelector('.no-print').classList.add('hidden');
    }

    function downloadImg() {
        html2canvas(document.querySelector("#boleta-impresion")).then(canvas => {
            const link = document.createElement('a'); link.download = `Boleta_CAI.png`; link.href = canvas.toDataURL(); link.click();
        });
    }

    function closeBoleta() { document.getElementById('container-boleta').classList.add('hidden'); document.querySelector('.no-print').classList.remove('hidden'); }
    function editAl(id) {
        const al = data.find(x => x.id === id);
        document.getElementById('edit-id').value = id;
        document.getElementById('nc').value = al.code;
        document.getElementById('nn').value = al.name;
        document.getElementById('ng').value = al.grade;
    }
</script>
</body>
</html>
