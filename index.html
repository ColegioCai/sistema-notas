<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA CAI 2026 - GESTI√ìN TOTAL</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --p: #1a5276; --bg: #f4f6f7; --orange: #e67e22; --dark: #2c3e50; --green: #27ae60; --red: #e74c3c; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; font-size: 11px; }
        
        .header-app { display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px 20px; border-bottom: 4px solid var(--orange); position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tabs { display: flex; background: #1c2833; padding: 10px 10px 0; gap: 4px; overflow-x: auto; }
        .tab { padding: 10px 15px; color: #bdc3c7; cursor: pointer; border-radius: 6px 6px 0 0; background: rgba(255,255,255,0.05); border: none; font-size: 10px; white-space: nowrap; }
        .tab.active { background: var(--bg); color: var(--p); font-weight: bold; }
        
        .container { max-width: 1400px; margin: 15px auto; padding: 0 15px; }
        .table-card { background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); overflow-x: auto; padding: 15px; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { background: #f8f9fa; padding: 12px 5px; border-bottom: 2px solid #dee2e6; color: var(--p); font-size: 9px; text-transform: uppercase; }
        td { padding: 8px 5px; border-bottom: 1px solid #eee; text-align: center; }
        
        .nota-input { width: 45px; padding: 6px; text-align: center; border: 1.5px solid #dcdde1; border-radius: 6px; font-weight: bold; }
        .btn { padding: 10px 20px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-add { background: var(--p); color: white; }
        .btn-del { background: none; color: var(--red); border: 1px solid var(--red); padding: 4px 8px; font-size: 14px; border-radius: 4px; }
        .btn-del:hover { background: var(--red); color: white; }
        
        .panel-registro { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 5px solid var(--p); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .hidden { display: none !important; }
        input, select { padding: 10px; border-radius: 8px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        
        #login-screen { height:100vh; display:flex; align-items:center; justify-content:center; background:var(--dark); }
        .login-box { background: white; padding: 40px; border-radius: 20px; width: 320px; text-align: center; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <img src="https://i.ibb.co/Mkf051St/Logo-CAI.png" width="80">
            <h2 style="color:var(--p);">SISTEMA CAI 2026</h2>
            <input type="text" id="user" placeholder="Usuario">
            <input type="password" id="pass" placeholder="Contrase√±a">
            <button onclick="login()" style="width:100%; padding:12px; background:var(--orange); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">INGRESAR</button>
            <p id="error" style="color:red; font-size:10px; margin-top:10px;"></p>
        </div>
    </div>

    <div id="app" class="hidden">
        <div class="header-app">
            <div style="display:flex; align-items:center; gap:12px;">
                <img src="https://i.ibb.co/Mkf051St/Logo-CAI.png" height="50">
                <div><b id="txt-grado" style="font-size:16px; color:var(--p);">---</b><br>
                <span id="txt-rol" style="color:var(--orange); font-weight:700; font-size:10px;">ROL: ---</span></div>
            </div>
            <div style="display:flex; gap:10px; align-items:center;">
                <select id="sel-grado" onchange="cambiarGrado()" style="margin:0; width:200px;"></select>
                <button onclick="generarBoletas()" class="btn" style="background:var(--green); color:white;">üìë BOLETAS</button>
                <button onclick="location.reload()" class="btn" style="background:var(--red); color:white;">SALIR</button>
            </div>
        </div>

        <nav id="nav-tabs" class="tabs"></nav>

        <div class="container">
            <div id="panel-admin" class="panel-registro hidden">
                <b style="color:var(--p)">MATRICULAR NUEVO ALUMNO EN ESTE GRADO:</b>
                <div style="display:grid; grid-template-columns: 1fr 2fr 2fr auto; gap:10px; margin-top:12px;">
                    <input type="text" id="reg-nie" placeholder="NIE" style="margin:0">
                    <input type="text" id="reg-ape" placeholder="Apellidos" style="margin:0">
                    <input type="text" id="reg-nom" placeholder="Nombres" style="margin:0">
                    <button onclick="matricular()" class="btn btn-add">AGREGAR ALUMNO</button>
                </div>
            </div>

            <div class="table-card">
                <table>
                    <thead><tr id="table-head"></tr></thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBmw9CdeBr1Z11v0ye4af-WACBeCL5FDc4",
        authDomain: "academica-bcb50.firebaseapp.com",
        projectId: "academica-bcb50",
        databaseURL: "https://academica-bcb50-default-rtdb.firebaseio.com/"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const MATERIAS = {
        "K4": ["Taller de ingl√©s", "Taller globalizador", "Taller de matem√°tica", "Taller de expresi√≥n gr√°fica", "Taller de inform√°tica", "Taller de lectoescritura", "Taller de deporte", "Taller de Biblia"],
        "K5": ["Taller de ingl√©s", "Taller de Biblia", "Taller globalizador", "Taller de expresi√≥n gr√°fica", "Taller de matem√°tica", "Taller de inform√°tica", "Taller de lectoescritura", "Taller de deporte"],
        "K6": ["Taller de ingl√©s", "Taller de conversaci√≥n", "Taller de lectoescritura", "Taller de matem√°ticas", "Taller de inform√°tica", "Taller de desarrollo", "Educaci√≥n emocional", "Taller de Biblia", "Taller de deporte", "Taller de arte", "Taller de expresi√≥n gr√°fica"],
        "1G": ["Taller de n√∫meros", "Taller de Biblia", "Taller de Finanzas", "Taller de cuerpo y mente", "Taller de lectoescritura", "Cultura", "Exploraci√≥n", "Escuela y sociedad", "Lectura"],
        "C1": ["Comunicacion", "Numeros y formas", "Ciencia y tecnologia", "Ciudadania y valores", "Artes", "Desarrollo corporal"],
        "C2": ["Comunicacion y literatura", "Aritmetica y Finanzas", "Ciencia y tecnologia", "Ciudadania y valores", "Artes", "Desarrollo corporal"],
        "C3": ["Lenguaje y Literatura", "Ingles", "Matematica y datos", "Ciencia y tecnologia", "Ciudadania y valores", "Educacion fisica"],
        "Bach": ["Lenguaje y literatura", "Ingles", "Precalculo", "Ciencia y tecnologia", "Ciudadania y valores", "Educacion fisica", "Proyecto de vida", "Finanzas", "Ciencias de la computacion"]
    };

    const MESES = ["Febrero", "Marzo", "Trimestre 1", "Mayo", "Junio", "Trimestre 2", "Agosto", "Septiembre", "Trimestre 3"];
    const MESES_B = ["Evaluaci√≥n 1", "Evaluaci√≥n 2", "Periodo 1", "Evaluaci√≥n 3", "Evaluaci√≥n 4", "Periodo 2", "Evaluaci√≥n 5", "Evaluaci√≥n 6", "Periodo 3", "Periodo 4"];

    const GRADOS_DATA = [
        {val:"K4", t:"Kinder 4 A√±os", cat:"infancia"}, {val:"K5", t:"Kinder 5 A√±os", cat:"infancia"}, {val:"K6", t:"Kinder 6 A√±os", cat:"infancia"}, {val:"1G", t:"1¬∞ Grado", cat:"infancia"},
        {val:"2G", t:"2¬∞ Grado", cat:"docente"}, {val:"3G", t:"3¬∞ Grado", cat:"docente"},
        {val:"4G", t:"4¬∞ Grado", cat:"docente"}, {val:"5G", t:"5¬∞ Grado", cat:"docente"}, {val:"6G", t:"6¬∞ Grado", cat:"docente"},
        {val:"7G", t:"7¬∞ Grado", cat:"docente"}, {val:"8G", t:"8¬∞ Grado", cat:"docente"}, {val:"9G", t:"9¬∞ Grado", cat:"docente"},
        {val:"1B", t:"1¬∞ Bachillerato", cat:"bachillerato"}, {val:"2B", t:"2¬∞ Bachillerato", cat:"bachillerato"}
    ];

    let currentRol = "";
    let dataAlumnos = [];
    let periodoActual = "Febrero";
    let materiaVisualizada = "";

    function login() {
        const u = document.getElementById('user').value.toLowerCase();
        const p = document.getElementById('pass').value;
        let valid = false;
        if(u==='admin' && p==='admin2026') { currentRol='admin'; valid=true; }
        else if(u==='infancia' && p==='cai1') { currentRol='infancia'; valid=true; }
        else if(u==='docente' && p==='cai2') { currentRol='docente'; valid=true; }
        else if(u==='bachillerato' && p==='cai3') { currentRol='bachillerato'; valid=true; }
        if(valid) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('txt-rol').innerText = "ROL: " + currentRol.toUpperCase();
            if(currentRol==='admin') document.getElementById('panel-admin').classList.remove('hidden');
            cargarSelect();
        } else { document.getElementById('error').innerText = "Usuario o clave incorrectos"; }
    }

    function cargarSelect() {
        let options = "";
        const cats = {"infancia": "PRIMERA INFANCIA", "docente": "B√ÅSICA", "bachillerato": "BACHILLERATO"};
        Object.keys(cats).forEach(c => {
            if(currentRol === 'admin' || currentRol === c) {
                options += `<optgroup label="${cats[c]}">`;
                GRADOS_DATA.filter(g => g.cat === c).forEach(g => { options += `<option value="${g.val}">${g.t}</option>`; });
                options += `</optgroup>`;
            }
        });
        document.getElementById('sel-grado').innerHTML = options;
        cambiarGrado(); escucharDB();
    }

    function getCiclo(g) {
        if(["K4","K5","K6","1G"].includes(g)) return g;
        if(["2G","3G"].includes(g)) return "C1";
        if(["4G","5G","6G"].includes(g)) return "C2";
        if(["7G","8G","9G"].includes(g)) return "C3";
        return "Bach";
    }

    function cambiarGrado() {
        const g = document.getElementById('sel-grado').value;
        const ciclo = getCiclo(g);
        const lista = (ciclo === "Bach") ? MESES_B : MESES;
        periodoActual = lista[0];
        materiaVisualizada = MATERIAS[ciclo][0];
        document.getElementById('txt-grado').innerText = document.getElementById('sel-grado').options[document.getElementById('sel-grado').selectedIndex].text;
        document.getElementById('nav-tabs').innerHTML = lista.map(p => `<button class="tab ${p===periodoActual?'active':''}" onclick="setPeriodo('${p}', this)">${p}</button>`).join('');
        dibujar();
    }

    function setPeriodo(p, btn) {
        periodoActual = p;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        btn.classList.add('active'); dibujar();
    }

    function matricular() {
        const nie = document.getElementById('reg-nie').value;
        const ape = document.getElementById('reg-ape').value.toUpperCase();
        const nom = document.getElementById('reg-nom').value.toUpperCase();
        const gTxt = document.getElementById('sel-grado').options[document.getElementById('sel-grado').selectedIndex].text;
        if(!nie || !ape || !nom) return alert("Faltan datos");
        db.ref('alumnos').push({ nie, ape, nom, grado: gTxt });
        document.getElementById('reg-nie').value=""; document.getElementById('reg-ape').value=""; document.getElementById('reg-nom').value="";
    }

    function eliminarAlumno(id, nombre) {
        if(confirm(`¬øEst√° seguro de eliminar a ${nombre}? Esta acci√≥n no se puede deshacer.`)) {
            db.ref(`alumnos/${id}`).remove();
        }
    }

    function calcular(n, p, g) {
        const v = { t:parseFloat(n.t)||0, l:parseFloat(n.l)||0, lc:parseFloat(n.lc)||0, int:parseFloat(n.int)||0, ex:parseFloat(n.ex)||0 };
        const c = getCiclo(g);
        if(["K4","K5","K6","1G"].includes(c)) {
            return (p==="Trimestre 2") ? (v.t*0.15 + v.int*0.35 + v.ex*0.5).toFixed(1) : (v.t*0.5 + v.ex*0.5).toFixed(1);
        }
        const trim = p.includes("Trimestre") || p.includes("Periodo");
        return trim ? (v.t*0.1 + v.l*0.05 + v.lc*0.1 + v.int*0.35 + v.ex*0.4).toFixed(1) : (v.t*0.25 + v.l*0.2 + v.lc*0.15 + v.ex*0.4).toFixed(1);
    }

    function dibujar() {
        const g = document.getElementById('sel-grado').value;
        const ciclo = getCiclo(g);
        const gTxt = document.getElementById('sel-grado').options[document.getElementById('sel-grado').selectedIndex].text;
        const esp = ["K4","K5","K6","1G"].includes(ciclo);
        const trim = periodoActual.includes("Trimestre") || periodoActual.includes("Periodo");
        
        let h = `<th>Acci√≥n</th><th>Estudiante</th><th style="width:200px">Materia</th>`;
        if(esp) h += (periodoActual === "Trimestre 2") ? `<th>T(15%)</th><th>I(35%)</th><th>E(50%)</th>` : `<th>T(50%)</th><th>E(50%)</th>`;
        else h += trim ? `<th>T(10%)</th><th>L(5%)</th><th>LC(10%)</th><th>I(35%)</th><th>E(40%)</th>` : `<th>T(25%)</th><th>L(20%)</th><th>LC(15%)</th><th>P(40%)</th>`;
        h += `<th>PROM</th>`;
        document.getElementById('table-head').innerHTML = h;

        let fil = dataAlumnos.filter(a => a.grado === gTxt).sort((a,b) => a.ape.localeCompare(b.ape));
        let b = "";
        fil.forEach(al => {
            const n = al.notas?.[periodoActual]?.[materiaVisualizada] || {};
            b += `<tr>
                <td><button class="btn-del" onclick="eliminarAlumno('${al.id}', '${al.ape} ${al.nom}')">üóëÔ∏è</button></td>
                <td style="text-align:left"><b>${al.ape}</b>, ${al.nom}</td>
                <td><select onchange="materiaVisualizada=this.value; dibujar()">${MATERIAS[ciclo].map(m=>`<option ${m===materiaVisualizada?'selected':''}>${m}</option>`).join('')}</select></td>
                <td><input type="text" class="nota-input" value="${n.t||0}" onchange="save('${al.id}','t',this.value)"></td>`;
            if(!esp) b += `<td><input type="text" class="nota-input" value="${n.l||0}" onchange="save('${al.id}','l',this.value)"></td><td><input type="text" class="nota-input" value="${n.lc||0}" onchange="save('${al.id}','lc',this.value)"></td>`;
            if(trim || (esp && periodoActual === "Trimestre 2")) b += `<td><input type="text" class="nota-input" value="${n.int||0}" onchange="save('${al.id}','int',this.value)"></td>`;
            b += `<td><input type="text" class="nota-input" value="${n.ex||0}" onchange="save('${al.id}','ex',this.value)"></td>
                <td style="font-weight:bold; color:var(--p);">${calcular(n,periodoActual,g)}</td></tr>`;
        });
        document.getElementById('table-body').innerHTML = b;
    }

    function save(id, c, v) { 
        let n = parseFloat(v.replace(',','.')) || 0;
        if(n > 10) n = 10;
        db.ref(`alumnos/${id}/notas/${periodoActual}/${materiaVisualizada}/${c}`).set(n); 
    }
    
    function escucharDB() { 
        db.ref('alumnos').on('value', snap => { 
            const v = snap.val(); 
            dataAlumnos = v ? Object.keys(v).map(k=>({id:k, ...v[k]})) : []; 
            dibujar(); 
        }); 
    }

    function generarBoletas() {
        const val = document.getElementById('sel-grado').value;
        const gTxt = document.getElementById('sel-grado').options[document.getElementById('sel-grado').selectedIndex].text;
        const ciclo = getCiclo(val);
        const alumnos = dataAlumnos.filter(a => a.grado === gTxt);
        if(alumnos.length === 0) return alert("No hay alumnos");
        
        let win = window.open('', '_blank');
        let h = `<html><head><title>Boletas - ${gTxt}</title><style>
            @page { size: letter; margin: 0; }
            body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; }
            .boleta { height: 50vh; padding: 10mm; border-bottom: 1px dashed #000; box-sizing: border-box; position: relative; page-break-inside: avoid; }
            .header { display: flex; align-items: center; border-bottom: 2px solid #1a5276; padding-bottom: 10px; }
            .logo { height: 60px; margin-right: 20px; }
            table { width: 100%; border-collapse: collapse; font-size: 10px; margin-top: 10px; }
            th { background: #1a5276; color: white; padding: 6px; }
            td { border: 1px solid #ccc; padding: 5px; text-align: center; }
            .firma-area { display: flex; justify-content: space-around; margin-top: 40px; }
            .firma { border-top: 1px solid #000; width: 220px; text-align: center; font-size: 10px; }
        </style></head><body>`;

        alumnos.forEach((al, idx) => {
            const esp = ["K4","K5","K6","1G"].includes(ciclo);
            const trim = periodoActual.includes("Trimestre") || periodoActual.includes("Periodo");
            h += `<div class="boleta">
                <div class="header">
                    <img src="https://i.ibb.co/Mkf051St/Logo-CAI.png" class="logo">
                    <div><h2 style="margin:0; color:#1a5276;">COLEGIO AMIGOS DE ISRAEL</h2>
                    <b>REPORTE: ${periodoActual.toUpperCase()}</b></div>
                </div>
                <p><b>ALUMNO:</b> ${al.ape} ${al.nom} | <b>GRADO:</b> ${gTxt} | <b>NIE:</b> ${al.nie}</p>
                <table><thead><tr><th style="text-align:left">MATERIA</th>`;
            
            if(esp) h += (periodoActual === "Trimestre 2") ? `<th>T(15%)</th><th>I(35%)</th><th>E(50%)</th>` : `<th>T(50%)</th><th>E(50%)</th>`;
            else h += trim ? `<th>T(10%)</th><th>L(5%)</th><th>LC(10%)</th><th>I(35%)</th><th>E(40%)</th>` : `<th>T(25%)</th><th>L(20%)</th><th>LC(15%)</th><th>P(40%)</th>`;
            h += `<th>PROM</th></tr></thead><tbody>`;

            MATERIAS[ciclo].forEach(m => {
                const n = al.notas?.[periodoActual]?.[m] || {};
                h += `<tr><td style="text-align:left">${m}</td><td>${n.t||0}</td>`;
                if(!esp) h += `<td>${n.l||0}</td><td>${n.lc||0}</td>`;
                if(trim || (esp && periodoActual === "Trimestre 2")) h += `<td>${n.int||0}</td>`;
                h += `<td>${n.ex||0}</td><td><b>${calcular(n, periodoActual, val)}</b></td></tr>`;
            });

            h += `</tbody></table>
                <div class="firma-area"><div class="firma">DIRECCI√ìN</div><div class="firma">SELLO</div></div>
            </div>`;
            if((idx + 1) % 2 === 0) h += `<div style="page-break-after: always;"></div>`;
        });
        win.document.write(h + "</body></html>"); win.document.close();
        setTimeout(() => { win.print(); }, 500);
    }
</script>
</body>
</html>
