<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA CAI - Oficial</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --p: #1a5276; --bg: #f4f6f7; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; }
        .login-screen { height: 100vh; display: flex; align-items: center; justify-content: center; background: var(--p); }
        .card { background: white; padding: 25px; border-radius: 8px; width: 300px; text-align: center; }
        .container { max-width: 900px; margin: 20px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        input, select { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .row { display: grid; grid-template-columns: 80px 1fr 100px 80px 80px 80px; gap: 10px; padding: 10px; border-bottom: 1px solid #eee; align-items: center; }
        .btn { background: var(--p); color: white; border: none; padding: 10px; cursor: pointer; border-radius: 4px; width: 100%; font-weight: bold; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="login-box" class="login-screen">
        <div class="card">
            <h2 style="color:var(--p)">ACADÃ‰MICA CAI</h2>
            <input type="text" id="u" placeholder="Usuario">
            <input type="password" id="p" placeholder="ContraseÃ±a">
            <select id="r">
                <option value="Admin">Administrador</option>
                <option value="Matematica">Docente MatemÃ¡tica</option>
                <option value="Lenguaje">Docente Lenguaje</option>
                <option value="Ciencias">Docente Ciencias</option>
                <option value="Sociales">Docente Sociales</option>
            </select>
            <button class="btn" onclick="login()">ENTRAR</button>
        </div>
    </div>

    <div id="app" class="hidden">
        <div class="container">
            <button onclick="location.reload()" style="float:right; width:80px;" class="btn">SALIR</button>
            <h3>Panel: <span id="user-tag"></span></h3>

            <div id="admin-panel" class="hidden" style="background:#e8f6f3; padding:15px; border-radius:8px; margin-bottom:20px;">
                <b>Registrar Alumno:</b>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <input type="text" id="nc" placeholder="CÃ³digo">
                    <input type="text" id="nn" placeholder="Nombre">
                    <input type="text" id="ng" placeholder="Grado">
                    <button class="btn" onclick="add()">AÃ‘ADIR</button>
                </div>
            </div>

            <input type="text" id="search" placeholder="ðŸ” BUSCAR POR NOMBRE O CÃ“DIGO..." onkeyup="draw()" style="font-size:18px; border:2px solid var(--p);">

            <div style="font-weight:bold; background:var(--p); color:white; margin-top:20px;" class="row">
                <span>CÃ“DIGO</span><span>ALUMNO</span><span>GRADO</span><span>ACT(60)</span><span>EXA(40)</span><span>PROM</span>
            </div>
            <div id="list"></div>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBmw9CdeBr1Z11v0ye4af-WACBeCL5FDc4",
        authDomain: "academica-bcb50.firebaseapp.com",
        projectId: "academica-bcb50",
        databaseURL: "https://academica-bcb50-default-rtdb.firebaseio.com/",
        storageBucket: "academica-bcb50.firebasestorage.app"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let role = "";
    let data = [];

    function login() {
        const user = document.getElementById('u').value;
        const pass = document.getElementById('p').value;
        const sel = document.getElementById('r').value;

        // Credenciales institucionales
        const creds = { 
            "Admin": ["Registro","Admin"], 
            "Matematica": ["prof_mate","cai2026"],
            "Lenguaje": ["prof_lenguaje","cai2026"],
            "Ciencias": ["prof_ciencias","cai2026"],
            "Sociales": ["prof_sociales","cai2026"]
        };

        if(creds[sel] && user === creds[sel][0] && pass === creds[sel][1]) {
            role = sel;
            document.getElementById('login-box').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('user-tag').innerText = sel;
            if(role === "Admin") document.getElementById('admin-panel').classList.remove('hidden');
            
            db.ref('alumnos').on('value', (s) => {
                const val = s.val();
                data = val ? Object.keys(val).map(k => ({id:k, ...val[k]})) : [];
                draw();
            });
        } else { alert("Datos incorrectos"); }
    }

    function add() {
        const c = document.getElementById('nc').value;
        const n = document.getElementById('nn').value;
        const g = document.getElementById('ng').value;
        if(!c || !n) return;
        db.ref('alumnos').push({
            code: c, name: n, grade: g,
            notas: { Matematica:{a:0,e:0}, Lenguaje:{a:0,e:0}, Ciencias:{a:0,e:0}, Sociales:{a:0,e:0} }
        });
        document.getElementById('nc').value=""; document.getElementById('nn').value="";
    }

    function update(id, mat, field, val) {
        db.ref(`alumnos/${id}/notas/${mat}/${field}`).set(parseFloat(val) || 0);
    }

    function draw() {
        const s = document.getElementById('search').value.toLowerCase();
        const list = document.getElementById('list');
        list.innerHTML = "";

        data.filter(a => a.name.toLowerCase().includes(s) || a.code.toLowerCase().includes(s)).forEach(al => {
            // Si es Admin, mostramos el promedio general. Si es Profe, mostramos su materia.
            const m = (role === "Admin") ? "Matematica" : role; 
            const n = al.notas[m] || {a:0, e:0};
            const p = (n.a * 0.6 + n.e * 0.4).toFixed(2);
            
            // Solo se habilita si es Admin o si es el profesor de esa materia
            const canEdit = (role === "Admin" || role === m) ? "" : "disabled";

            list.innerHTML += `
                <div class="row">
                    <span>${al.code}</span>
                    <span>${al.name}</span>
                    <span style="font-size:12px; color:#777;">${al.grade}</span>
                    <input type="number" value="${n.a}" onchange="update('${al.id}','${m}','a',this.value)" ${canEdit}>
                    <input type="number" value="${n.e}" onchange="update('${al.id}','${m}','e',this.value)" ${canEdit}>
                    <b style="color:${p >= 7 ? 'green':'red'}">${p}</b>
                </div>`;
        });
    }
</script>
</body>
</html>
