<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA CAI 2026 - GITHUB DEPLOY</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --p: #1a5276; --bg: #f4f6f7; --orange: #e67e22; --dark: #2c3e50; --green: #27ae60; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; font-size: 11px; }
        .header-app { display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px 20px; border-bottom: 4px solid var(--orange); position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .tabs { display: flex; background: #1c2833; padding: 10px 10px 0; gap: 4px; overflow-x: auto; }
        .tab { padding: 10px 15px; color: #bdc3c7; cursor: pointer; border-radius: 6px 6px 0 0; background: rgba(255,255,255,0.05); border: none; font-size: 10px; white-space: nowrap; }
        .tab.active { background: var(--bg); color: var(--p); font-weight: bold; }
        .container { max-width: 1400px; margin: 15px auto; padding: 0 15px; }
        .table-card { background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); overflow-x: auto; padding: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th { background: #f8f9fa; padding: 12px 5px; border-bottom: 2px solid #dee2e6; color: var(--p); font-size: 9px; text-transform: uppercase; }
        td { padding: 8px 5px; border-bottom: 1px solid #eee; text-align: center; }
        .nota-input { width: 45px; padding: 6px; text-align: center; border: 1.5px solid #dcdde1; border-radius: 6px; font-weight: bold; }
        .panel-registro { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #e0e6ed; }
        .btn { padding: 10px 20px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-add { background: var(--p); color: white; }
        .btn-print { background: var(--green); color: white; margin-left: 10px; }
        .badge-eval { font-size: 10px; padding: 6px 15px; border-radius: 20px; background: #ebf5fb; color: var(--p); font-weight: bold; margin-bottom: 15px; display: inline-block; }
        .hidden { display: none !important; }
        .login-box { background: white; padding: 40px; border-radius: 20px; width: 320px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        input[type="text"], input[type="password"], select { padding: 10px; border-radius: 8px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; margin-bottom: 15px; }
    </style>
</head>
<body>

    <div id="login-screen" style="height:100vh; display:flex; align-items:center; justify-content:center; background:var(--dark);">
        <div class="login-box">
            <img src="https://i.ibb.co/Mkf051St/Logo-CAI.png" alt="Logo CAI" width="80">
            <h2 style="color:var(--p);">SISTEMA CAI 2026</h2>
            <input type="text" id="user" placeholder="Usuario">
            <input type="password" id="pass" placeholder="Contrase침a">
            <button onclick="login()" style="width:100%; padding:12px; background:var(--orange); color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">INGRESAR</button>
            <p id="error" style="color:red; font-size:11px; margin-top:10px;"></p>
        </div>
    </div>

    <div id="app" class="hidden">
        <div class="header-app">
            <div style="display:flex; align-items:center; gap:12px;">
                <img src="https://i.ibb.co/Mkf051St/Logo-CAI.png" height="50">
                <div>
                    <b id="txt-grado" style="font-size:16px; color:var(--p);">---</b><br>
                    <span id="txt-rol" style="color:var(--orange); font-weight:700; font-size:10px;">ROL: ---</span>
                </div>
            </div>
            <div style="display:flex; gap:10px; align-items:center;">
                <select id="sel-grado" onchange="cambiarGrado()" style="margin-bottom:0; width:200px;"></select>
                <button onclick="generarBoletas()" class="btn btn-print">游늼 BOLETAS</button>
                <button onclick="location.reload()" class="btn" style="background:#e74c3c; color:white;">SALIR</button>
            </div>
        </div>

        <nav id="nav-tabs" class="tabs"></nav>

        <div class="container">
            <div id="panel-admin" class="panel-registro hidden">
                <b style="color:var(--p)">MATRICULAR EN ESTE GRADO:</b>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <input type="text" id="reg-nie" placeholder="C칩digo Estudiante" style="width:150px; margin:0">
                    <input type="text" id="reg-ape" placeholder="Apellidos" style="margin:0">
                    <input type="text" id="reg-nom" placeholder="Nombres" style="margin:0">
                    <button onclick="matricular()" class="btn btn-add">REGISTRAR</button>
                </div>
            </div>

            <div id="info-porcentajes" class="badge-eval"></div>
            
            <div class="table-card">
                <table>
                    <thead><tr id="table-head"></tr></thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

<script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBmw9CdeBr1Z11v0ye4af-WACBeCL5FDc4",
        authDomain: "academica-bcb50.firebaseapp.com",
        projectId: "academica-bcb50",
        databaseURL: "https://academica-bcb50-default-rtdb.firebaseio.com/"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const MATERIAS = {
        "K4": ["Taller de ingl칠s", "Taller globalizador", "Taller de matem치tica", "Taller de expresi칩n gr치fica", "Taller de inform치tica", "Taller de lectoescritura", "Taller de deporte", "Taller de Biblia"],
        "K5": ["Taller de ingl칠s", "Taller de Biblia", "Taller globalizador", "Taller de expresi칩n gr치fica", "Taller de matem치tica", "Taller de inform치tica", "Taller de lectoescritura", "Taller de deporte"],
        "K6": ["Taller de ingl칠s", "Taller de conversaci칩n", "Taller de lectoescritura", "Taller de matem치ticas", "Taller de inform치tica", "Taller de desarrollo", "Educaci칩n emocional y h치bitos higi칠nicos", "Taller de Biblia", "Taller de deporte", "Taller de arte", "Taller de expresi칩n gr치fica"],
        "1G": ["Taller de n칰meros", "Taller de Biblia", "Taller de Finanzas", "Taller de cuerpo, mente y personalidad", "Taller de lectoescritura", "Cultura", "Educaci칩n y experiencia / exploraci칩n", "Escuela y sociedad", "Lectura"],
        "C1": ["Comunicacion", "Numeros y formas", "Ciencia y tecnologia", "Ciudadania y valores", "Artes", "Desarrollo corporal"],
        "C2": ["Comunicacion y literatura", "Aritmetica y Finanzas", "Ciencia y tecnologia", "Ciudadania y valores", "Artes", "Desarrollo corporal"],
        "C3": ["Lenguaje y Literatura", "Ingles", "Matematica y datos", "Ciencia y tecnologia", "Ciudadania y valores", "Educacion fisica y deportes"],
        "Bach": ["Lenguaje y literatura", "Ingles", "Precalculo", "Ciencia y tecnologia", "Ciudadania y valores", "Educacion fisica y deportes", "Proyecto de vida y carrera", "Finanzas y economia", "Ciencias de la computacion"]
    };

    const MESES = ["Febrero", "Marzo", "Trimestre 1", "Mayo", "Junio", "Trimestre 2", "Agosto", "Septiembre", "Trimestre 3"];
    const MESES_B = ["Evaluaci칩n 1", "Evaluaci칩n 2", "Periodo 1", "Evaluaci칩n 3", "Evaluaci칩n 4", "Periodo 2", "Evaluaci칩n 5", "Evaluaci칩n 6", "Periodo 3", "Periodo 4"];

    const GRADOS_DATA = [
        {val:"K4", t:"Kinder 4 A침os", cat:"infancia"}, {val:"K5", t:"Kinder 5 A침os", cat:"infancia"}, {val:"K6", t:"Kinder 6 A침os", cat:"infancia"}, {val:"1G", t:"1춿 Grado", cat:"infancia"},
        {val:"2G", t:"2춿 Grado", cat:"docente"}, {val:"3G", t:"3춿 Grado", cat:"docente"},
        {val:"4G", t:"4춿 Grado", cat:"docente"}, {val:"5G", t:"5춿 Grado", cat:"docente"}, {val:"6G", t:"6춿 Grado", cat:"docente"},
        {val:"7G", t:"7춿 Grado", cat:"docente"}, {val:"8G", t:"8춿 Grado", cat:"docente"}, {val:"9G", t:"9춿 Grado", cat:"docente"},
        {val:"1B", t:"1춿 Bachillerato", cat:"bachillerato"}, {val:"2B", t:"2춿 Bachillerato", cat:"bachillerato"}
    ];

    let currentRol = "";
    let dataAlumnos = [];
    let periodoActual = "Febrero";
    let materiaVisualizada = "";

    function login() {
        const u = document.getElementById('user').value.toLowerCase();
        const p = document.getElementById('pass').value;
        let valid = false;
        if(u==='admin' && p==='admin2026') { currentRol='admin'; valid=true; }
        else if(u==='infancia' && p==='cai1') { currentRol='infancia'; valid=true; }
        else if(u==='docente' && p==='cai2') { currentRol='docente'; valid=true; }
        else if(u==='bachillerato' && p==='cai3') { currentRol='bachillerato'; valid=true; }
        
        if(valid) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            document.getElementById('txt-rol').innerText = "ROL: " + currentRol.toUpperCase();
            if(currentRol==='admin') document.getElementById('panel-admin').classList.remove('hidden');
            cargarSelect();
        } else { document.getElementById('error').innerText = "Usuario o Clave incorrectos"; }
    }

    function cargarSelect() {
        let options = "";
        const cats = {"infancia": "PRIMERA INFANCIA", "docente": "B츼SICA (CICLOS 1-3)", "bachillerato": "BACHILLERATO"};
        Object.keys(cats).forEach(c => {
            if(currentRol === 'admin' || currentRol === c) {
                options += `<optgroup label="${cats[c]}">`;
                GRADOS_DATA.filter(g => g.cat === c).forEach(g => { options += `<option value="${g.val}">${g.t}</option>`; });
                options += `</optgroup>`;
            }
        });
        document.getElementById('sel-grado').innerHTML = options;
        cambiarGrado(); escucharDB();
    }

    function matricular() {
        const nie = document.getElementById('reg-nie').value;
        const ape = document.getElementById('reg-ape').value.toUpperCase();
        const nom = document.getElementById('reg-nom').value.toUpperCase();
        const grado = document.getElementById('sel-grado').options[document.getElementById('sel-grado').selectedIndex].text;
        if(!nie || !ape || !nom) return alert("Faltan datos");
        db.ref('alumnos').push({ nie, ape, nom, grado });
        document.getElementById('reg-nie').value=""; document.getElementById('reg-ape').value=""; document.getElementById('reg-nom').value="";
    }

    function getCiclo(g) {
        if(["K4","K5","K6","1G"].includes(g)) return g;
        if(["2G","3G"].includes(g)) return "C1";
        if(["4G","5G","6G"].includes(g)) return "C2";
        if(["7G","8G","9G"].includes(g)) return "C3";
        return "Bach";
    }

    function cambiarGrado() {
        const g = document.getElementById('sel-grado').value;
        const ciclo = getCiclo(g);
        const lista = (ciclo === "Bach") ? MESES_B : MESES;
        periodoActual = lista[0];
        materiaVisualizada = MATERIAS[ciclo][0];
        document.getElementById('txt-grado').innerText = document.getElementById('sel-grado').options[document.getElementById('sel-grado').selectedIndex].text;
        document.getElementById('nav-tabs').innerHTML = lista.map(p => `<button class="tab ${p===periodoActual?'active':''}" onclick="setPeriodo('${p}', this)">${p}</button>`).join('');
        dibujar();
    }

    function setPeriodo(p, btn) {
        periodoActual = p;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        btn.classList.add('active'); dibujar();
    }

    function calcular(n, p, g) {
        const v = { t:parseFloat(n.t)||0, l:parseFloat(n.l)||0, lc:parseFloat(n.lc)||0, int:parseFloat(n.int)||0, ex:parseFloat(n.ex)||0 };
        const c = getCiclo(g);
        if(["K4","K5","K6","1G"].includes(c)) {
            return (p==="Trimestre 2") ? (v.t*0.15 + v.int*0.35 + v.ex*0.5).toFixed(1) : (v.t*0.5 + v.ex*0.5).toFixed(1);
        }
        const trim = p.includes("Trimestre") || p.includes("Periodo");
        return trim ? (v.t*0.1 + v.l*0.05 + v.lc*0.1 + v.int*0.35 + v.ex*0.4).toFixed(1) : (v.t*0.25 + v.l*0.2 + v.lc*0.15 + v.ex*0.4).toFixed(1);
    }

    function dibujar() {
        const g = document.getElementById('sel-grado').value;
        const ciclo = getCiclo(g);
        const gTxt = document.getElementById('sel-grado').options[document.getElementById('sel-grado').selectedIndex].text;
        const esp = ["K4","K5","K6","1G"].includes(ciclo);
        const trim = periodoActual.includes("Trimestre") || periodoActual.includes("Periodo");
        let h = `<th>Estudiante</th><th style="width:200px">Materia</th>`;
        if(esp) h += (periodoActual === "Trimestre 2") ? `<th>T (15%)</th><th>I (35%)</th><th>E (50%)</th>` : `<th>T (50%)</th><th>E (50%)</th>`;
        else h += trim ? `<th>T(10%)</th><th>L(5%)</th><th>LC(10%)</th><th>I(35%)</th><th>E(40%)</th>` : `<th>T(25%)</th><th>L(20%)</th><th>LC(15%)</th><th>P(40%)</th>`;
        h += `<th>PROM</th>`;
        document.getElementById('table-head').innerHTML = h;
        let fil = dataAlumnos.filter(a => a.grado === gTxt).sort((a,b) => a.ape.localeCompare(b.ape));
        let b = "";
        fil.forEach(al => {
            const n = al.notas?.[periodoActual]?.[materiaVisualizada] || {};
            b += `<tr><td style="text-align:left"><b>${al.ape}</b>, ${al.nom}</td>
                <td><select style="width:100%" onchange="materiaVisualizada=this.value; dibujar()">${MATERIAS[ciclo].map(m=>`<option ${m===materiaVisualizada?'selected':''}>${m}</option>`).join('')}</select></td>
                <td><input type="text" class="nota-input" value="${n.t||0}" onchange="save('${al.id}','t',this.value)"></td>`;
            if(!esp) b += `<td><input type="text" class="nota-input" value="${n.l||0}" onchange="save('${al.id}','l',this.value)"></td><td><input type="text" class="nota-input" value="${n.lc||0}" onchange="save('${al.id}','lc',this.value)"></td>`;
            if(trim || (esp && periodoActual === "Trimestre 2")) b += `<td><input type="text" class="nota-input" value="${n.int||0}" onchange="save('${al.id}','int',this.value)"></td>`;
            b += `<td><input type="text" class="nota-input" value="${n.ex||0}" onchange="save('${al.id}','ex',this.value)"></td><td style="font-weight:bold; color:var(--p);">${calcular(n,periodoActual,g)}</td></tr>`;
        });
        document.getElementById('table-body').innerHTML = b;
    }

    function save(id, c, v) { db.ref(`alumnos/${id}/notas/${periodoActual}/${materiaVisualizada}/${c}`).set(parseFloat(v.replace(',','.')) || 0); }
    function escucharDB() { db.ref('alumnos').on('value', snap => { const v = snap.val(); dataAlumnos = v ? Object.keys(v).map(k=>({id:k, ...v[k]})) : []; dibujar(); }); }

    function generarBoletas() {
        const val = document.getElementById('sel-grado').value;
        const gTxt = document.getElementById('sel-grado').options[document.getElementById('sel-grado').selectedIndex].text;
        const ciclo = getCiclo(val);
        const alumnos = dataAlumnos.filter(a => a.grado === gTxt);
        if(alumnos.length === 0) return alert("No hay alumnos");
        
        let win = window.open('', '_blank');
        let h = `<html><head><title>Boletas CAI</title><style>
            @page { size: letter; margin: 0; }
            body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background: white; }
            .boleta { height: 50vh; padding: 10mm; border-bottom: 1px dashed #000; box-sizing: border-box; position: relative; overflow: hidden; page-break-inside: avoid; }
            .header { display: flex; align-items: center; border-bottom: 2px solid #1a5276; padding-bottom: 10px; margin-bottom: 10px; }
            .logo { height: 60px; margin-right: 20px; }
            .info-estudiante { display: grid; grid-template-columns: 2fr 1fr 1fr; font-size: 11px; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
            table { width: 100%; border-collapse: collapse; font-size: 10px; margin-top: 5px; }
            th { background: #1a5276; color: white; padding: 6px; text-transform: uppercase; }
            td { border: 1px solid #ccc; padding: 5px; text-align: center; }
            .firma-area { display: flex; justify-content: center; align-items: center; gap: 100px; margin-top: 40px; position: absolute; bottom: 18mm; width: 100%; }
            .firma-linea { border-top: 1px solid black; width: 220px; text-align: center; padding-top: 5px; font-size: 10px; font-weight: bold; }
            .sello-area { border: 1px dashed #ccc; width: 90px; height: 90px; font-size: 8px; color: #ccc; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
            .versiculo { position: absolute; bottom: 5mm; width: 100%; text-align: center; font-style: italic; font-size: 9px; color: #555; }
        </style></head><body>`;

        alumnos.forEach((al, idx) => {
            h += `<div class="boleta">
                <div class="header">
                    <img src="https://i.ibb.co/Mkf051St/Logo-CAI.png" class="logo">
                    <div>
                        <h2 style="margin:0; color:#1a5276; font-size: 18px;">COLEGIO AMIGOS DE ISRAEL</h2>
                        <span style="color:#e67e22; font-weight:bold; letter-spacing:1px;">REPORTE ACAD칄MICO - ${periodoActual.toUpperCase()}</span>
                    </div>
                </div>
                <div class="info-estudiante">
                    <div><b>ALUMNO:</b> ${al.ape} ${al.nom}</div>
                    <div><b>GRADO:</b> ${gTxt}</div>
                    <div><b>C칍DIGO:</b> ${al.nie}</div>
                </div>
                <table>
                    <thead><tr><th style="text-align:left">ASIGNATURA O TALLER</th><th>TAREAS</th><th>LAB/LIBRO</th><th>EXAMEN</th><th>PROMEDIO</th></tr></thead>
                    <tbody>`;
            MATERIAS[ciclo].forEach(m => {
                const n = al.notas?.[periodoActual]?.[m] || {};
                h += `<tr>
                        <td style="text-align:left; font-weight:bold;">${m.toUpperCase()}</td>
                        <td>${n.t||0}</td><td>${n.lc||0}</td><td>${n.ex||0}</td>
                        <td style="background:#f9f9f9; font-size:11px;"><b>${calcular(n, periodoActual, val)}</b></td>
                    </tr>`;
            });
            h += `</tbody></table>
                <div class="firma-area">
                    <div class="firma-linea">FIRMA DE LA DIRECTORA</div>
                    <div class="sello-area">SELLO CAI</div>
                </div>
                <div class="versiculo">"Instruye al ni침o en su camino, y aun cuando fuere viejo no se apratar치 de 칠l." - Proverbios 22:6</div>
            </div>`;
            if((idx + 1) % 2 === 0) h += `<div style="page-break-after: always;"></div>`;
        });
        win.document.write(h + "</body></html>"); win.document.close();
        setTimeout(() => { win.print(); }, 500);
    }
</script>
</body>
</html>
